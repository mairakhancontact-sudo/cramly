<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cramly | Student Mode</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<!-- Chart.js for Statistics -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ===== CSS VARIABLES ===== */
:root {
  /* Light theme (default) */
  --bg: #f8fafc;
  --card: #ffffff;
  --text: #1e293b;
  --text-muted: #64748b;
  --border: #e2e8f0;
  --accent: #4f46e5;
  --accent-dark: #4338ca;
  --accent-light: #e0e7ff;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --info: #3b82f6;
  --purple: #8b5cf6;
  
  /* Spacing */
  --spacing-xs: 0.5rem;
  --spacing-sm: 0.75rem;
  --spacing-md: 1rem;
  --spacing-lg: 1.5rem;
  --spacing-xl: 2rem;
  --spacing-2xl: 3rem;
  
  /* Border Radius */
  --radius-sm: 0.5rem;
  --radius: 0.75rem;
  --radius-lg: 1rem;
  --radius-xl: 1.25rem;
  --radius-2xl: 1.5rem;
  
  /* Shadows */
  --shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.12);
  --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.15);
  --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.2);
  
  /* Transitions */
  --transition-fast: 0.2s ease;
  --transition: 0.3s ease;
  --transition-slow: 0.5s ease;
  
  /* Gradients */
  --gradient-primary: linear-gradient(135deg, var(--accent), var(--accent-dark));
  --gradient-success: linear-gradient(135deg, var(--success), #059669);
  --gradient-warning: linear-gradient(135deg, var(--warning), #d97706);
  --gradient-danger: linear-gradient(135deg, var(--danger), #dc2626);
  --gradient-info: linear-gradient(135deg, var(--info), #2563eb);
  --gradient-purple: linear-gradient(135deg, var(--purple), #7c3aed);
}

/* ===== THEMES ===== */
body.dark {
  --bg: #0f172a;
  --card: #1e293b;
  --text: #f1f5f9;
  --text-muted: #94a3b8;
  --border: #334155;
  --accent-light: rgba(79, 70, 229, 0.2);
  --shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
  --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.5);
}

body.ocean {
  --bg: #0c4a6e;
  --card: #075985;
  --text: #e0f2fe;
  --text-muted: #7dd3fc;
  --border: #0369a1;
  --accent: #0891b2;
  --accent-dark: #0e7490;
  --accent-light: rgba(8, 145, 178, 0.2);
}

body.forest {
  --bg: #064e3b;
  --card: #047857;
  --text: #d1fae5;
  --text-muted: #a7f3d0;
  --border: #059669;
  --accent: #059669;
  --accent-dark: #047857;
  --accent-light: rgba(5, 150, 105, 0.2);
}

body.sunset {
  --bg: #7c2d12;
  --card: #c2410c;
  --text: #ffedd5;
  --text-muted: #fed7aa;
  --border: #ea580c;
  --accent: #ea580c;
  --accent-dark: #c2410c;
  --accent-light: rgba(234, 88, 12, 0.2);
}

body.purple {
  --bg: #1e1b4b;
  --card: #312e81;
  --text: #e0e7ff;
  --text-muted: #a5b4fc;
  --border: #4f46e5;
  --accent: #8b5cf6;
  --accent-dark: #7c3aed;
  --accent-light: rgba(139, 92, 246, 0.2);
}

/* ===== BASE STYLES ===== */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  background: var(--bg);
  color: var(--text);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
  line-height: 1.6;
  min-height: 100vh;
  transition: all var(--transition);
  overflow-x: hidden;
}

/* ===== NEW LAYOUT STRUCTURE ===== */
.app-layout {
  display: grid;
  grid-template-columns: 280px 1fr;
  min-height: 100vh;
}

/* ===== SIDEBAR ===== */
.sidebar {
  background: var(--card);
  border-right: 1px solid var(--border);
  padding: var(--spacing-xl);
  position: sticky;
  top: 0;
  height: 100vh;
  overflow-y: auto;
}

.sidebar-header {
  text-align: center;
  margin-bottom: var(--spacing-2xl);
  padding-bottom: var(--spacing-xl);
  border-bottom: 1px solid var(--border);
}

.student-emoji {
  font-size: 3.5rem;
  margin-bottom: var(--spacing-md);
  display: block;
  animation: float 3s ease-in-out infinite;
}

@keyframes float {
  0%, 100% { transform: translateY(0) rotate(0deg); }
  50% { transform: translateY(-10px) rotate(2deg); }
}

.sidebar h2 {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text);
  margin-bottom: var(--spacing-xs);
}

.sidebar-subtitle {
  color: var(--text-muted);
  font-size: 0.875rem;
  margin-bottom: var(--spacing-lg);
}

/* Class switcher */
.class-switcher {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: var(--spacing-md);
  margin-bottom: var(--spacing-xl);
}

.class-switcher select {
  width: 100%;
  padding: 0.5rem;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--card);
  color: var(--text);
  font-size: 0.875rem;
}

.sidebar-nav {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xs);
  margin-bottom: var(--spacing-xl);
}

.nav-item {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding: var(--spacing-md) var(--spacing-lg);
  border-radius: var(--radius);
  color: var(--text);
  text-decoration: none;
  font-weight: 500;
  transition: all var(--transition);
  border: 1px solid transparent;
  cursor: pointer;
}

.nav-item:hover {
  background: var(--accent-light);
  border-color: var(--accent);
  transform: translateX(5px);
}

.nav-item.active {
  background: var(--gradient-primary);
  color: white;
}

.nav-item.active:hover {
  background: var(--gradient-primary);
  border-color: transparent;
}

.sidebar-stats {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: var(--spacing-lg);
  margin-bottom: var(--spacing-xl);
}

.sidebar-stats h3 {
  font-size: 0.875rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  margin-bottom: var(--spacing-md);
}

.stat-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--spacing-sm) 0;
  border-bottom: 1px solid var(--border);
}

.stat-row:last-child {
  border-bottom: none;
}

.stat-value {
  font-weight: 700;
  font-size: 1.125rem;
  color: var(--accent);
}

/* Inspiring Stories Section */
.stories-section {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: var(--spacing-lg);
  margin-top: var(--spacing-xl);
  max-height: 300px;
  overflow-y: auto;
}

.stories-section h3 {
  font-size: 0.875rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  margin-bottom: var(--spacing-md);
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
}

.story-item {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: var(--spacing-md);
  margin-bottom: var(--spacing-sm);
  cursor: pointer;
  transition: all var(--transition);
}

.story-item:hover {
  background: var(--accent-light);
  border-color: var(--accent);
  transform: translateY(-2px);
}

.story-name {
  font-weight: 600;
  color: var(--text);
  margin-bottom: var(--spacing-xs);
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
}

.story-quote {
  font-size: 0.875rem;
  color: var(--text-muted);
  font-style: italic;
  line-height: 1.4;
}

/* Story Modal */
.story-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  z-index: 1001;
  align-items: center;
  justify-content: center;
  padding: var(--spacing-xl);
}

.story-modal-content {
  background: var(--card);
  border-radius: var(--radius-lg);
  max-width: 600px;
  width: 100%;
  max-height: 80vh;
  overflow-y: auto;
  position: relative;
  border: 2px solid var(--accent);
}

.story-modal-header {
  padding: var(--spacing-xl);
  border-bottom: 1px solid var(--border);
  background: var(--gradient-primary);
  color: white;
  border-radius: var(--radius-lg) var(--radius-lg) 0 0;
}

.story-modal-body {
  padding: var(--spacing-xl);
}

.story-modal-close {
  position: absolute;
  top: var(--spacing-lg);
  right: var(--spacing-lg);
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.25rem;
  z-index: 1002;
}

.story-modal-close:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* ===== MAIN CONTENT ===== */
.main-content {
  padding: var(--spacing-xl);
  overflow-y: auto;
  max-width: 1400px;
  margin: 0 auto;
  width: 100%;
}

/* ===== DASHBOARD HEADER ===== */
.dashboard-header {
  margin-bottom: var(--spacing-2xl);
}

.dashboard-header h1 {
  font-size: 2.5rem;
  font-weight: 800;
  margin-bottom: var(--spacing-sm);
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.dashboard-subtitle {
  color: var(--text-muted);
  font-size: 1.125rem;
  margin-bottom: var(--spacing-xl);
}

.controls-bar {
  display: flex;
  gap: var(--spacing-md);
  align-items: center;
  flex-wrap: wrap;
  padding: var(--spacing-lg);
  background: var(--card);
  border-radius: var(--radius-lg);
  border: 1px solid var(--border);
  margin-bottom: var(--spacing-xl);
}

/* ===== PRO TIPS - MATCHING TEACHER MODE ===== */
.pro-tip {
  background: var(--accent-light);
  border-left: 4px solid var(--accent);
  padding: var(--spacing-md);
  border-radius: var(--radius);
  margin: var(--spacing-md) 0;
  font-size: 0.875rem;
  position: relative;
}

.pro-tip strong {
  color: var(--accent);
  display: block;
  margin-bottom: var(--spacing-xs);
  font-size: 0.9375rem;
}

.pro-tip::before {
  content: 'üí°';
  position: absolute;
  left: -12px;
  top: 50%;
  transform: translateY(-50%);
  background: var(--accent);
  color: white;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  box-shadow: var(--shadow);
}

.dark .pro-tip {
  background: rgba(79, 70, 229, 0.15);
  border-left-color: var(--accent);
}

.dark .pro-tip strong {
  color: var(--accent-light);
}

/* ===== DASHBOARD GRID ===== */
.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(12, 1fr);
  gap: var(--spacing-xl);
}

/* Quick Stats */
.quick-stats {
  grid-column: span 12;
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: var(--spacing-lg);
}

.stat-card {
  background: var(--card);
  border-radius: var(--radius-lg);
  padding: var(--spacing-xl);
  border: 1px solid var(--border);
  transition: all var(--transition);
  display: flex;
  align-items: center;
  gap: var(--spacing-lg);
}

.stat-card:hover {
  transform: translateY(-5px);
  box-shadow: var(--shadow-lg);
}

.stat-icon {
  width: 64px;
  height: 64px;
  border-radius: var(--radius);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.75rem;
  background: var(--gradient-primary);
  color: white;
  flex-shrink: 0;
}

.stat-card:nth-child(2) .stat-icon {
  background: var(--gradient-success);
}

.stat-card:nth-child(3) .stat-icon {
  background: var(--gradient-warning);
}

.stat-card:nth-child(4) .stat-icon {
  background: var(--gradient-info);
}

.stat-content {
  flex: 1;
}

.stat-number {
  font-size: 2.5rem;
  font-weight: 800;
  line-height: 1;
  margin-bottom: var(--spacing-xs);
  color: var(--text);
}

.stat-label {
  font-size: 0.875rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 600;
}

/* Forms Section */
.forms-section {
  grid-column: span 4;
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xl);
}

.form-card {
  background: var(--card);
  border-radius: var(--radius-lg);
  padding: var(--spacing-xl);
  border: 1px solid var(--border);
  transition: all var(--transition);
}

.form-card:hover {
  box-shadow: var(--shadow-md);
}

.form-card h2 {
  font-size: 1.25rem;
  font-weight: 700;
  margin-bottom: var(--spacing-lg);
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}

/* Form Elements */
.form-group {
  margin-bottom: var(--spacing-lg);
}

.form-group label {
  display: block;
  margin-bottom: var(--spacing-xs);
  font-weight: 600;
  color: var(--text);
  font-size: 0.875rem;
}

input, textarea, select {
  width: 100%;
  padding: 0.875rem 1rem;
  border: 2px solid var(--border);
  border-radius: var(--radius);
  background: var(--bg);
  color: var(--text);
  font-size: 0.9375rem;
  font-family: inherit;
  transition: all var(--transition-fast);
}

input:focus, textarea:focus, select:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-light);
  background: var(--card);
}

textarea {
  min-height: 120px;
  resize: vertical;
  line-height: 1.6;
}

.btn-submit {
  width: 100%;
  padding: 1rem;
  background: var(--gradient-primary);
  color: white;
  border: none;
  border-radius: var(--radius);
  font-weight: 700;
  font-size: 1rem;
  cursor: pointer;
  transition: all var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-sm);
}

.btn-submit:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);
}

/* Task Priority Badges */
.priority-badge {
  padding: 0.25rem 0.75rem;
  border-radius: 1rem;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
}

.priority-urgent {
  background: rgba(239, 68, 68, 0.1);
  color: var(--danger);
  border: 1px solid var(--danger);
}

.priority-not-urgent {
  background: rgba(245, 158, 11, 0.1);
  color: var(--warning);
  border: 1px solid var(--warning);
}

.priority-optional {
  background: rgba(156, 163, 175, 0.1);
  color: var(--text-muted);
  border: 1px solid var(--text-muted);
}

.priority-selector {
  display: flex;
  gap: var(--spacing-sm);
  margin-bottom: var(--spacing-md);
}

.priority-option {
  flex: 1;
  padding: 0.5rem;
  border: 2px solid var(--border);
  border-radius: var(--radius-sm);
  text-align: center;
  cursor: pointer;
  transition: all var(--transition);
  font-size: 0.875rem;
  font-weight: 500;
}

.priority-option:hover {
  transform: translateY(-2px);
}

.priority-option.active {
  border-color: var(--accent);
  background: var(--accent-light);
}

.priority-option[data-priority="urgent"]:hover,
.priority-option[data-priority="urgent"].active {
  border-color: var(--danger);
  background: rgba(239, 68, 68, 0.1);
}

.priority-option[data-priority="not-urgent"]:hover,
.priority-option[data-priority="not-urgent"].active {
  border-color: var(--warning);
  background: rgba(245, 158, 11, 0.1);
}

.priority-option[data-priority="optional"]:hover,
.priority-option[data-priority="optional"].active {
  border-color: var(--text-muted);
  background: rgba(156, 163, 175, 0.1);
}

/* Content Section */
.content-section {
  grid-column: span 8;
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xl);
}

.content-card {
  background: var(--card);
  border-radius: var(--radius-lg);
  border: 1px solid var(--border);
  overflow: hidden;
}

.content-header {
  padding: var(--spacing-xl);
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.content-header h2 {
  font-size: 1.25rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}

.content-body {
  padding: var(--spacing-xl);
  max-height: 400px;
  overflow-y: auto;
}

/* Task List */
.task-list {
  list-style: none;
  padding: 0;
  animation: fadeIn 0.8s ease-out;
}

.task-item {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: var(--spacing-lg);
  margin-bottom: var(--spacing-md);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: var(--spacing-md);
  transition: all var(--transition);
  position: relative;
  overflow: hidden;
}

.task-item::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 4px;
  background: var(--gradient-primary);
  opacity: 0;
  transition: var(--transition);
}

.task-item:hover {
  border-color: var(--accent);
  transform: translateX(10px);
  box-shadow: var(--shadow);
  background: var(--accent-light);
}

.task-item:hover::before {
  opacity: 1;
}

.task-item.completed {
  opacity: 0.7;
  border-left: 4px solid var(--success);
}

.task-item.completed .task-text {
  text-decoration: line-through;
  color: var(--text-muted);
}

.task-item.urgent {
  border-left: 4px solid var(--danger);
}

.task-item.not-urgent {
  border-left: 4px solid var(--warning);
}

.task-item.optional {
  border-left: 4px solid var(--text-muted);
}

.task-text {
  flex: 1;
  min-width: 200px;
  font-size: 1.1rem;
  font-weight: 500;
  cursor: pointer;
  padding: 0.5rem 0;
  transition: var(--transition);
}

.task-text:hover {
  color: var(--accent);
}

.task-actions {
  display: flex;
  gap: var(--spacing-sm);
  flex-wrap: wrap;
  align-items: center;
}

/* Assignment List */
.assignment-list {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-md);
}

.assignment-item {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: var(--spacing-lg);
  transition: all var(--transition);
}

.assignment-item:hover {
  transform: translateX(5px);
  border-color: var(--accent);
  box-shadow: var(--shadow);
}

.assignment-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: var(--spacing-sm);
}

.assignment-title {
  font-weight: 600;
  color: var(--text);
  font-size: 1.125rem;
}

.assignment-date {
  color: var(--text-muted);
  font-size: 0.8125rem;
  font-weight: 500;
  background: var(--card);
  padding: 0.25rem 0.75rem;
  border-radius: 1rem;
  border: 1px solid var(--border);
  white-space: nowrap;
}

.assignment-content {
  color: var(--text);
  margin-bottom: var(--spacing-md);
  line-height: 1.7;
  padding: 0.5rem 0;
}

.assignment-actions {
  display: flex;
  justify-content: flex-end;
  gap: var(--spacing-sm);
}

/* Classroom Announcements & Resources */
.classroom-item {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: var(--spacing-lg);
  margin-bottom: var(--spacing-md);
  transition: all var(--transition);
}

.classroom-item:hover {
  transform: translateX(5px);
  border-color: var(--accent);
  box-shadow: var(--shadow);
}

.classroom-item-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: var(--spacing-sm);
}

.classroom-item-title {
  font-weight: 600;
  color: var(--text);
  font-size: 1.125rem;
}

.classroom-item-date {
  color: var(--text-muted);
  font-size: 0.8125rem;
  font-weight: 500;
  background: var(--card);
  padding: 0.25rem 0.75rem;
  border-radius: 1rem;
  border: 1px solid var(--border);
}

.classroom-item-content {
  color: var(--text);
  margin-bottom: var(--spacing-md);
  line-height: 1.7;
}

.classroom-item-link {
  color: var(--accent);
  text-decoration: none;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.classroom-item-link:hover {
  text-decoration: underline;
}

/* Tools Grid */
.tools-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: var(--spacing-lg);
  margin-top: var(--spacing-lg);
}

.tool-item {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: var(--spacing-xl);
  text-align: center;
  transition: all var(--transition);
  cursor: pointer;
  text-decoration: none;
  color: var(--text);
  display: block;
}

.tool-item:hover {
  border-color: var(--accent);
  transform: translateY(-8px);
  box-shadow: var(--shadow-xl);
  background: var(--accent-light);
}

.tool-icon {
  font-size: 3rem;
  margin-bottom: var(--spacing-md);
  display: inline-block;
  animation: iconBounce 2s ease-in-out infinite;
}

@keyframes iconBounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

.tool-name {
  font-size: 1.25rem;
  font-weight: 700;
  margin-bottom: var(--spacing-xs);
  color: var(--accent);
}

.tool-desc {
  font-size: 0.875rem;
  color: var(--text-muted);
  line-height: 1.4;
}

/* ===== BUTTONS ===== */
.btn {
  padding: 0.75rem 1.5rem;
  border-radius: var(--radius);
  border: none;
  font-weight: 600;
  font-size: 0.9375rem;
  cursor: pointer;
  transition: all var(--transition);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

.btn-primary {
  background: var(--gradient-primary);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);
}

.btn-success {
  background: var(--gradient-success);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.btn-success:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
}

.btn-warning {
  background: var(--gradient-warning);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.btn-warning:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
}

.btn-danger {
  background: var(--gradient-danger);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.btn-danger:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
}

.btn-secondary {
  background: var(--card);
  color: var(--text);
  border: 1px solid var(--border);
}

.btn-secondary:hover {
  background: var(--accent-light);
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.btn-icon {
  width: 40px;
  height: 40px;
  padding: 0;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ===== TOAST NOTIFICATIONS ===== */
.toast-container {
  position: fixed;
  top: 24px;
  right: 24px;
  z-index: 1000;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.toast {
  min-width: 300px;
  padding: 1.125rem 1.5rem;
  border-radius: var(--radius);
  background: var(--card);
  color: var(--text);
  box-shadow: var(--shadow-xl);
  display: flex;
  align-items: center;
  gap: 0.875rem;
  animation: slideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  border-left: 4px solid var(--accent);
  border: 1px solid var(--border);
}

@keyframes slideIn {
  from { 
    opacity: 0; 
    transform: translateY(20px) scale(0.95); 
  }
  to { 
    opacity: 1; 
    transform: translateY(0) scale(1); 
  }
}

.toast.success { border-left-color: var(--success); }
.toast.error { border-left-color: var(--danger); }
.toast.warning { border-left-color: var(--warning); }
.toast.info { border-left-color: var(--info); }

/* ===== IMPROVED STREAK CARD ===== */
.streak-card {
  background: var(--gradient-warning);
  color: white;
  text-align: center;
  padding: var(--spacing-xl);
  border-radius: var(--radius-lg);
  position: relative;
  overflow: hidden;
}

.streak-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 50%, rgba(255,255,255,0.1) 100%);
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

.streak-number {
  font-size: 4rem;
  font-weight: 900;
  line-height: 1;
  margin: var(--spacing-md) 0;
  text-shadow: 0 4px 20px rgba(0,0,0,0.3);
  position: relative;
  z-index: 1;
}

.streak-label {
  font-size: 1.25rem;
  opacity: 0.9;
  margin-bottom: var(--spacing-lg);
  position: relative;
  z-index: 1;
}

.streak-milestones {
  display: flex;
  justify-content: center;
  gap: var(--spacing-sm);
  margin: var(--spacing-md) 0;
  position: relative;
  z-index: 1;
}

.milestone {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.3);
}

.milestone.active {
  background: white;
  box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
}

.streak-btn {
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: 2px solid rgba(255, 255, 255, 0.3);
  padding: 1rem 2rem;
  border-radius: var(--radius);
  font-size: 1.1rem;
  font-weight: 700;
  cursor: pointer;
  transition: var(--transition);
  display: inline-flex;
  align-items: center;
  gap: 0.75rem;
  width: 100%;
  justify-content: center;
  position: relative;
  z-index: 1;
}

.streak-btn:hover:not(:disabled) {
  background: rgba(255, 255, 255, 0.3);
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
}

.streak-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.streak-progress {
  height: 6px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 3px;
  margin: var(--spacing-md) 0;
  position: relative;
  z-index: 1;
  overflow: hidden;
}

.streak-progress-fill {
  height: 100%;
  background: white;
  border-radius: 3px;
  transition: width 0.5s ease;
  position: relative;
}

.streak-progress-fill::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
  animation: progressShimmer 2s infinite;
}

@keyframes progressShimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

/* ===== MOTIVATION CARD ===== */
.motivation-card {
  background: var(--gradient-purple);
  color: white;
  position: relative;
  overflow: hidden;
}

.motivation-card::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
}

.quote-text {
  font-size: 1.5rem;
  font-style: italic;
  line-height: 1.6;
  margin-bottom: var(--spacing-md);
  position: relative;
  z-index: 1;
  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.quote-author {
  font-size: 1.1rem;
  opacity: 0.9;
  position: relative;
  z-index: 1;
  text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

/* ===== CLASS CODE DISPLAY ===== */
.class-code-display {
  background: var(--gradient-primary);
  color: white;
  padding: var(--spacing-xl);
  border-radius: var(--radius-lg);
  margin: var(--spacing-xl) 0;
  text-align: center;
  position: relative;
  overflow: hidden;
}

.class-code-display::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.1) 75%, transparent 75%);
  background-size: 20px 20px;
}

.class-code-display .code {
  font-size: 3rem;
  font-weight: 900;
  letter-spacing: 0.5rem;
  font-family: 'Courier New', monospace;
  margin: var(--spacing-md) 0;
  text-shadow: 0 4px 20px rgba(0,0,0,0.3);
  position: relative;
  z-index: 1;
}

/* ===== MULTIPLE CLASSES VIEW ===== */
.classes-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: var(--spacing-lg);
  margin-top: var(--spacing-lg);
}

.class-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: var(--spacing-xl);
  transition: all var(--transition);
  position:relative;
  overflow: hidden;
}

.class-card:hover {
  border-color: var(--accent);
  transform: translateY(-5px);
  box-shadow: var(--shadow-lg);
}

.class-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--spacing-md);
}

.class-card-title {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--text);
}

.class-card-code {
  background: var(--accent);
  color: white;
  padding: 0.25rem 0.75rem;
  border-radius: 1rem;
  font-family: 'Courier New', monospace;
  font-size: 0.875rem;
  font-weight: 700;
}

.class-card-stats {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: var(--spacing-sm);
  margin-top: var(--spacing-md);
}

.class-card-stat {
  text-align: center;
  padding: var(--spacing-sm);
  background: var(--bg);
  border-radius: var(--radius);
  border: 1px solid var(--border);
}

.class-card-stat .value {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--accent);
}

.class-card-stat .label {
  font-size: 0.75rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.class-card-actions {
  display: flex;
  gap: var(--spacing-sm);
  margin-top: var(--spacing-md);
}

/* ===== LEADERBOARD STYLES ===== */
.leaderboard-container {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-md);
}

.leaderboard-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-bottom: var(--spacing-md);
  border-bottom: 1px solid var(--border);
}

.leaderboard-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
  gap: var(--spacing-sm);
  margin-bottom: var(--spacing-md);
}

.leaderboard-stat {
  text-align: center;
  padding: var(--spacing-sm);
  background: var(--bg);
  border-radius: var(--radius);
  border: 1px solid var(--border);
}

.leaderboard-stat .value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 0.25rem;
}

.leaderboard-stat .label {
  font-size: 0.75rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.leaderboard-list {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xs);
}

.leaderboard-item {
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
  padding: var(--spacing-md);
  background: var(--bg);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  transition: all var(--transition);
}

.leaderboard-item:hover {
  transform: translateX(5px);
  border-color: var(--accent);
  background: var(--accent-light);
}

.leaderboard-item.you {
  background: var(--gradient-primary);
  color: white;
  border-color: var(--accent-dark);
}

.leaderboard-item.you .rank,
.leaderboard-item.you .score,
.leaderboard-item.you .name {
  color: white;
}

.leaderboard-rank {
  font-size: 1.5rem;
  font-weight: 900;
  width: 40px;
  text-align: center;
  color: var(--accent);
}

.rank-1 .leaderboard-rank { color: #FFD700; }
.rank-2 .leaderboard-rank { color: #C0C0C0; }
.rank-3 .leaderboard-rank { color: #CD7F32; }

.leaderboard-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--gradient-primary);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  color: white;
  font-size: 1.25rem;
  flex-shrink: 0;
}

.leaderboard-info {
  flex: 1;
}

.leaderboard-name {
  font-weight: 700;
  font-size: 1.125rem;
}

.leaderboard-subtitle {
  font-size: 0.875rem;
  color: var(--text-muted);
  margin-top: 0.25rem;
}

.leaderboard-item.you .leaderboard-subtitle {
  color: rgba(255, 255, 255, 0.8);
}

.leaderboard-score {
  font-weight: 700;
  font-size: 1.25rem;
  color: var(--accent);
  text-align: right;
  min-width: 80px;
}

.leaderboard-stats-row {
  display: flex;
  gap: var(--spacing-sm);
  margin-top: var(--spacing-sm);
}

.stats-badge {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 1rem;
  padding: 0.25rem 0.75rem;
  font-size: 0.75rem;
  color: var(--text-muted);
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.stats-badge.fire { color: var(--warning); }
.stats-badge.time { color: var(--info); }
.stats-badge.points { color: var(--success); }

.leaderboard-empty {
  text-align: center;
  padding: var(--spacing-2xl);
  color: var(--text-muted);
}

/* ===== STATISTICS SECTION - UPDATED ===== */
.charts-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: var(--spacing-xl);
  margin-top: var(--spacing-xl);
}

.chart-card {
  background: var(--card);
  border-radius: var(--radius-lg);
  padding: var(--spacing-xl);
  border: 1px solid var(--border);
  transition: all var(--transition);
}

.chart-card:hover {
  box-shadow: var(--shadow-md);
}

.chart-card h3 {
  font-size: 1.25rem;
  font-weight: 700;
  margin-bottom: var(--spacing-lg);
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}

.chart-wrapper {
  position: relative;
  height: 300px;
  width: 100%;
}

/* New Statistics Charts */
.daily-stats-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: var(--spacing-lg);
  margin-bottom: var(--spacing-xl);
}

.daily-stat-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: var(--spacing-lg);
  text-align: center;
  transition: var(--transition);
}

.daily-stat-card:hover {
  transform: translateY(-5px);
  box-shadow: var(--shadow-md);
}

.daily-stat-number {
  font-size: 2.5rem;
  font-weight: 800;
  color: var(--accent);
  margin-bottom: var(--spacing-xs);
}

.daily-stat-label {
  font-size: 0.875rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: var(--spacing-sm);
}

.daily-stat-trend {
  font-size: 0.875rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-xs);
}

.trend-up {
  color: var(--success);
}

.trend-down {
  color: var(--danger);
}

.trend-neutral {
  color: var(--text-muted);
}

/* Study Session Button */
.study-session-btn {
  margin-top: var(--spacing-md);
  width: 100%;
}

.stat-summary-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: var(--spacing-lg);
  margin-top: var(--spacing-xl);
}

.stat-summary-card {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: var(--spacing-lg);
  text-align: center;
  transition: var(--transition);
}

.stat-summary-card:hover {
  transform: translateY(-5px);
  border-color: var(--accent);
}

.stat-summary-number {
  font-size: 2.5rem;
  font-weight: 800;
  color: var(--accent);
  margin-bottom: var(--spacing-xs);
}

.stat-summary-label {
  font-size: 0.875rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.stat-summary-details {
  font-size: 0.875rem;
  color: var(--text);
  margin-top: var(--spacing-sm);
}

.comparison-chart {
  grid-column: span 2;
}

/* ===== FOOTER WITH COPYRIGHT ===== */
.footer {
  grid-column: span 12;
  text-align: center;
  padding: var(--spacing-xl);
  margin-top: var(--spacing-2xl);
  color: var(--text-muted);
  font-size: 0.875rem;
  border-top: 1px solid var(--border);
}

.footer a {
  color: var(--accent);
  text-decoration: none;
}

.footer a:hover {
  text-decoration: underline;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 1400px) {
  .dashboard-grid {
    grid-template-columns: 1fr;
  }
  
  .forms-section,
  .content-section {
    grid-column: span 1;
  }
  
  .quick-stats {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .charts-container {
    grid-template-columns: 1fr;
  }
  
  .comparison-chart {
    grid-column: span 1;
  }
  
  .daily-stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 1200px) {
  .app-layout {
    grid-template-columns: 240px 1fr;
  }
}

@media (max-width: 992px) {
  .app-layout {
    grid-template-columns: 1fr;
  }
  
  .sidebar {
    display: none;
  }
  
  .quick-stats {
    grid-template-columns: repeat(4, 1fr);
  }
  
  .controls-bar {
    flex-direction: column;
    align-items: stretch;
  }
  
  .daily-stats-grid {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 768px) {
  .quick-stats {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .dashboard-header h1 {
    font-size: 2rem;
  }
  
  .controls-bar {
    padding: var(--spacing-md);
  }
  
  .main-content {
    padding: var(--spacing-md);
  }
  
  .tools-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .leaderboard-item {
    flex-wrap: wrap;
    gap: var(--spacing-sm);
  }
  
  .leaderboard-score {
    text-align: left;
    min-width: auto;
  }
  
  .classes-grid {
    grid-template-columns: 1fr;
  }
  
  .charts-container {
    grid-template-columns: 1fr;
  }
  
  .chart-card {
    padding: var(--spacing-md);
  }
  
  .chart-wrapper {
    height: 250px;
  }
}

@media (max-width: 576px) {
  .quick-stats {
    grid-template-columns: 1fr;
  }
  
  .stat-card {
    flex-direction: column;
    text-align: center;
    gap: var(--spacing-md);
  }
  
  .tools-grid {
    grid-template-columns: 1fr;
  }
  
  .btn {
    width: 100%;
  }
  
  .stat-summary-grid {
    grid-template-columns: 1fr;
  }
}

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar { 
  width: 8px; 
  height: 8px;
}

::-webkit-scrollbar-track { 
  background: var(--bg); 
  border-radius: 4px;
}

::-webkit-scrollbar-thumb { 
  background: var(--accent); 
  border-radius: 4px;
  border: 2px solid var(--bg);
}

::-webkit-scrollbar-thumb:hover { 
  background: var(--accent-dark); 
}

/* ===== LOADING STATES ===== */
.loading {
  text-align: center;
  padding: var(--spacing-2xl);
  color: var(--text-muted);
  font-size: 1.125rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--spacing-md);
}

.loading::after {
  content: '';
  width: 40px;
  height: 40px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* ===== EMPTY STATES ===== */
.empty-state {
  text-align: center;
  padding: var(--spacing-2xl);
  color: var(--text-muted);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--spacing-md);
}

.empty-state-icon {
  font-size: 4rem;
  margin-bottom: var(--spacing-lg);
  opacity: 0.5;
}

.empty-state-title {
  font-size: 1.5rem;
  margin-bottom: var(--spacing-sm);
  color: var(--text);
}

.empty-state-description {
  font-size: 1rem;
  line-height: 1.6;
}

/* ===== SYNC STATUS ===== */
.sync-status {
  position: fixed;
  top: 80px;
  right: 20px;
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: var(--spacing-sm) var(--spacing-md);
  font-size: 0.875rem;
  z-index: 999;
  box-shadow: var(--shadow);
  display: flex;
  align-items: center;
  gap: 0.5rem;
  backdrop-filter: blur(10px);
  animation: fadeIn 0.5s ease-out;
}
</style>
</head>

<body>

<div class="app-layout">
  
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="student-emoji">üë®‚Äçüéì</div>
      <h2>Student Dashboard</h2>
      <p class="sidebar-subtitle">Track Your Learning Journey</p>
    </div>
    
    <!-- Class Switcher -->
    <div class="class-switcher">
      <select id="classSelector" onchange="switchClass(this.value)">
        <option value="">Select a Class</option>
      </select>
    </div>
    
    <nav class="sidebar-nav">
      <div class="nav-item active" onclick="showSection('dashboard')">
        üìä Dashboard
      </div>
      <div class="nav-item" onclick="showSection('tasks')">
        üìù Tasks
      </div>
      <div class="nav-item" onclick="showSection('assignments')">
        üìö Assignments
      </div>
      <div class="nav-item" onclick="showSection('classroom')">
        üè´ Classroom
      </div>
      <div class="nav-item" onclick="showSection('myclasses')">
        üéì My Classes
      </div>
      <div class="nav-item" onclick="showSection('statistics')">
        üìà Statistics
      </div>
      <div class="nav-item" onclick="showSection('tools')">
        üõ†Ô∏è Study Tools
      </div>
      <div class="nav-item" onclick="showSection('ai')">
        ü§ñ AI Help
      </div>
      <div class="nav-item" onclick="showSection('profile')">
        üë§ Profile
      </div>
      <!-- New Study Group Button -->
      <div class="nav-item" onclick="window.location.href='studygroup.html'">
        üë• Study Group
      </div>
    </nav>
    
    <div class="sidebar-stats">
      <h3>Today's Stats</h3>
      <div class="stat-row">
        <span>Study Streak</span>
        <span class="stat-value" id="sidebarStreak">0</span>
      </div>
      <div class="stat-row">
        <span>Total Hours</span>
        <span class="stat-value" id="sidebarHours">0</span>
      </div>
      <div class="stat-row">
        <span>Tasks Done</span>
        <span class="stat-value" id="sidebarTasks">0</span>
      </div>
      <div class="stat-row">
        <span>Focus Score</span>
        <span class="stat-value" id="sidebarFocus">0%</span>
      </div>
    </div>
    
    <!-- Inspiring Stories Section -->
    <div class="stories-section">
      <h3>üåü Inspiring Stories</h3>
      <div id="storiesList">
        <!-- Stories will be loaded here -->
      </div>
    </div>
    
    <div style="margin-top: var(--spacing-xl);">
      <select class="theme-selector" onchange="changeTheme(this.value)" style="width: 100%; padding: 0.875rem; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text);">
        <option value="light">‚òÄÔ∏è Light Theme</option>
        <option value="dark">üåô Dark Theme</option>
        <option value="ocean">üåä Ocean Theme</option>
        <option value="forest">üå≤ Forest Theme</option>
        <option value="sunset">üåÖ Sunset Theme</option>
        <option value="purple">üíú Purple Theme</option>
      </select>
    </div>
  </aside>
  
  <!-- Story Modal -->
  <div id="storyModal" class="story-modal">
    <div class="story-modal-content">
      <button class="story-modal-close" onclick="closeStoryModal()">√ó</button>
      <div class="story-modal-header">
        <h2 id="storyModalTitle"></h2>
      </div>
      <div class="story-modal-body">
        <div id="storyModalContent"></div>
      </div>
    </div>
  </div>
  
  <!-- Main Content -->
  <main class="main-content">
    
    <!-- Dashboard Header -->
    <div class="dashboard-header" id="dashboardHeader">
      <h1>Welcome to Your Learning Dashboard</h1>
      <p class="dashboard-subtitle" id="dashboardSubtitle">Track your progress, manage tasks, and achieve your study goals</p>
      
      <div class="controls-bar">
        <button class="btn btn-success" onclick="window.location.href='index.html'">
    Home
</button>
        <button class="btn btn-success" onclick="showSection('myclasses')">üéì Manage Classes</button>
        <button class="btn btn-secondary" onclick="refreshData()">üîÑ Refresh</button>
        <button class="btn btn-warning" onclick="exportData()">üì§ Export Data</button>
      </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>
    
    <!-- Sync Status -->
    <div id="syncStatus" class="sync-status" style="display: none;">
      <span class="sync-icon"></span>
      <span class="sync-text"></span>
    </div>
    
    <!-- Dashboard Grid -->
    <div class="dashboard-grid">
      
      <!-- Dashboard Section -->
      <div id="dashboard" class="dashboard-content" style="grid-column: span 12; display: block;">
        
        <!-- Pro Tip - Matching Teacher Mode Style -->
        <div class="pro-tip">
          <strong>üí° Daily Habit Building</strong>
          Mark your study streak daily! Consistency beats intensity. Even 15 minutes of focused study each day builds a strong habit and improves retention by 60% compared to cramming.
        </div>
        
        <!-- Quick Stats -->
        <div class="quick-stats">
          <div class="stat-card">
            <div class="stat-icon">üî•</div>
            <div class="stat-content">
              <div class="stat-number" id="streakDisplay">0</div>
              <div class="stat-label">Study Streak</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">‚è∞</div>
            <div class="stat-content">
              <div class="stat-number" id="totalHoursDisplay">0</div>
              <div class="stat-label">Study Hours</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-content">
              <div class="stat-number" id="tasksCompletedDisplay">0</div>
              <div class="stat-label">Tasks Done</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üéØ</div>
            <div class="stat-content">
              <div class="stat-number" id="focusScoreDisplay">0%</div>
              <div class="stat-label">Focus Score</div>
            </div>
          </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="dashboard-grid" style="margin-top: var(--spacing-xl);">
          
          <!-- Left Column: Forms & Motivation -->
          <div class="forms-section">
            <!-- Profile Form -->
            <div class="form-card">
              <h2>üë§ My Profile</h2>
              <div class="pro-tip" style="margin: 0 0 var(--spacing-lg) 0;">
                <strong>Tip:</strong> Complete your profile to personalize your learning experience and track progress accurately.
              </div>
              <div class="form-group">
                <label for="studentName">Your Name</label>
                <input type="text" id="studentName" placeholder="Enter your name">
              </div>
              <div class="form-group">
                <label for="studentEmail">Email (Optional)</label>
                <input type="email" id="studentEmail" placeholder="your@email.com">
              </div>
              <div class="form-group">
                <label for="studentBio">Bio</label>
                <textarea id="studentBio" placeholder="Tell us about yourself..." rows="3"></textarea>
              </div>
              <button class="btn-submit" onclick="saveProfile()">
                üíæ Save Profile
              </button>
            </div>
            
            <!-- IMPROVED Streak Card -->
            <div class="form-card streak-card">
              <h2 style="color: white; position: relative; z-index: 1;">üî• Daily Study Streak</h2>
              <div class="streak-number" id="streakNumber">0</div>
              <div class="streak-label" id="streakLabel">DAY STREAK</div>
              
              <!-- Streak Milestones -->
              <div class="streak-milestones" id="streakMilestones">
                <!-- Milestones will be added by JavaScript -->
              </div>
              
              <!-- Streak Progress -->
              <div class="streak-progress">
                <div class="streak-progress-fill" id="streakProgressFill" style="width: 0%"></div>
              </div>
              
              <button class="streak-btn" id="streakButton" onclick="markStudyToday()">
                <span>üî• Mark Study Today</span>
              </button>
              <div id="streakMessage" style="margin-top: var(--spacing-md); font-weight: 600; min-height: 24px; position: relative; z-index: 1;"></div>
              <div id="streakInfo" style="margin-top: var(--spacing-sm); font-size: 0.875rem; opacity: 0.8; position: relative; z-index: 1;">
                Last studied: <span id="lastStudyDate">Never</span>
              </div>
              <div id="streakReward" style="margin-top: var(--spacing-sm); font-size: 0.75rem; opacity: 0.7; position: relative; z-index: 1;">
                Next milestone: <span id="nextMilestone">7 days</span>
              </div>
            </div>
            
            <!-- Motivation Card -->
            <div class="form-card motivation-card">
              <h2 style="color: white; position: relative; z-index: 1;">üí´ Daily Inspiration</h2>
              <div class="quote-text" id="dailyQuote">"The only way to do great work is to love what you do."</div>
              <div class="quote-author" id="quoteAuthor">‚Äî Steve Jobs</div>
              <button class="btn" onclick="newQuote()" style="margin-top: var(--spacing-lg); background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.3); color: white; width: 100%; position: relative; z-index: 1;">
                üîÑ New Inspiration
              </button>
            </div>
          </div>
          
          <!-- Right Column: Tasks & Assignments -->
          <div class="content-section">
            <!-- Tasks Card -->
            <div class="content-card">
              <div class="content-header">
                <h2>üìù My Tasks</h2>
                <button class="btn btn-primary" onclick="showSection('tasks')">View All</button>
              </div>
              <div class="content-body">
                <div class="pro-tip" style="margin: 0 0 var(--spacing-lg) 0;">
                  <strong>Tip:</strong> Break large tasks into smaller, manageable chunks. This reduces overwhelm and increases completion rates by 40%.
                </div>

                <div class="task-input-container" style="display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-lg);">
                  <input type="text" id="taskInput" placeholder="Add a new task..." style="flex: 1;">
                  <button class="btn btn-success" onclick="addTask()">‚ûï Add</button>
                </div>
                <!-- Add this AFTER the task input container in the Dashboard section -->
<div class="priority-selector" style="margin-bottom: var(--spacing-md);">
    <div class="priority-option active" data-priority="urgent" onclick="selectPriority('urgent')">
        üî¥ Urgent
    </div>
    <div class="priority-option" data-priority="not-urgent" onclick="selectPriority('not-urgent')">
        üü° Not Urgent
    </div>
    <div class="priority-option" data-priority="optional" onclick="selectPriority('optional')">
        ‚ö™ Optional
    </div>
</div>
                <ul class="task-list" id="taskList">
                  <!-- Tasks will appear here -->
                </ul>
              </div>
            </div>
            
            <!-- Assignments Card -->
            <div class="content-card">
              <div class="content-header">
                <h2>üìö My Assignments</h2>
                <button class="btn btn-primary" onclick="showSection('assignments')">View All</button>
              </div>
              <div class="content-body">
                <div class="pro-tip" style="margin: 0 0 var(--spacing-lg) 0;">
                  <strong>Tip:</strong> Start assignments early! Students who begin assignments 3 days before the due date score 15% higher on average.
                </div>
                <div class="assignment-list" id="assignmentList">
                  <!-- Assignments will appear here -->
                </div>
              </div>
            </div>
            
            <!-- Study Hours Input -->
            <div class="content-card">
              <div class="content-header">
                <h2>‚è∞ Add Study Hours</h2>
              </div>
              <div class="content-body">
                <div class="pro-tip" style="margin: 0 0 var(--spacing-lg) 0;">
                  <strong>Tip:</strong> Use the Pomodoro Technique: 25 minutes of focused study followed by a 5-minute break improves concentration and retention.
                </div>
                <div class="form-group">
                  <label for="hoursInput">Study Hours (e.g., 2.5)</label>
                  <input type="number" id="hoursInput" placeholder="Enter study hours" step="0.25" min="0.25" max="12">
                </div>
                <button class="btn-submit" onclick="addStudyHours()">
                  ‚è∞ Add Hours
                </button>
                <div style="font-size: 0.875rem; color: var(--text-muted); text-align: center; margin-top: var(--spacing-md);">
                  Track your study sessions to see your progress!
                </div>
              </div>
            </div>
          </div>
          
        </div>
        
        <!-- Footer with Copyright -->
        <div class="footer">
          <p>¬© 2024 Student Learning Dashboard. All rights reserved. Made with ‚ù§Ô∏è for students everywhere.</p>
          <p style="margin-top: var(--spacing-sm); font-size: 0.75rem; opacity: 0.7;">
            Education is the most powerful weapon which you can use to change the world. ‚Äî Nelson Mandela
          </p>
        </div>
      </div>
      
      <!-- Tasks Section -->
      <div id="tasks" class="dashboard-content" style="grid-column: span 12; display: none;">
        <div class="content-card">
          <div class="content-header">
            <h2>üìù Task Manager</h2>
            <div style="display: flex; gap: var(--spacing-sm);">
              <button class="btn btn-secondary" onclick="filterTasks('all')">All</button>
              <button class="btn btn-secondary" onclick="filterTasks('urgent')">Urgent</button>
              <button class="btn btn-secondary" onclick="filterTasks('not-urgent')">Not Urgent</button>
              <button class="btn btn-secondary" onclick="filterTasks('optional')">Optional</button>
              <button class="btn btn-secondary" onclick="filterTasks('active')">Active</button>
              <button class="btn btn-secondary" onclick="filterTasks('completed')">Completed</button>
            </div>
          </div>
          <div class="content-body">
            <div class="pro-tip">
              <strong>üí° Task Management Strategy</strong>
              Prioritize tasks using the Eisenhower Matrix: Urgent & Important (do first), Important but Not Urgent (schedule), Urgent but Not Important (delegate if possible), Neither (eliminate).
            </div>
            
            <!-- Simplified - tasks are already added from dashboard -->
<div style="text-align: center; margin-bottom: var(--spacing-xl); padding: var(--spacing-lg); background: var(--bg); border-radius: var(--radius); border: 1px solid var(--border);">
    <p style="margin-bottom: var(--spacing-md);">Tasks are added from the Dashboard section above.</p>
    <button class="btn btn-primary" onclick="showSection('dashboard')">
        ‚Üê Back to Dashboard to Add Tasks
    </button>
</div>
            
            <div class="task-filters" style="display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-xl);">
              <button class="btn btn-warning" onclick="clearCompletedTasks()">Clear Completed</button>
              <button class="btn btn-secondary" onclick="exportTasks()">Export Tasks</button>
            </div>
            
            <ul class="task-list" id="fullTaskList">
              <!-- Full task list will appear here -->
            </ul>
            
            <div class="task-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--spacing-lg); margin-top: var(--spacing-xl); padding: var(--spacing-lg); background: var(--bg); border-radius: var(--radius); border: 1px solid var(--border);">
              <div class="stat-display">
                <div class="number" id="totalTasks">0</div>
                <div class="label">Total Tasks</div>
              </div>
              <div class="stat-display">
                <div class="number" id="pendingTasks">0</div>
                <div class="label">Pending</div>
              </div>
              <div class="stat-display">
                <div class="number" id="completedTasks">0</div>
                <div class="label">Completed</div>
              </div>
              <div class="stat-display">
                <div class="number" id="completionRate">0%</div>
                <div class="label">Completion Rate</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Assignments Section -->
      <div id="assignments" class="dashboard-content" style="grid-column: span 12; display: none;">
        <div class="content-card">
          <div class="content-header">
            <h2>üìö Assignment Tracker</h2>
            <button class="btn btn-primary" onclick="showAssignmentForm()">‚ûï Add Assignment</button>
          </div>
          <div class="content-body">
            <!-- Pro Tip -->
            <div class="pro-tip">
              <strong>üí° Assignment Strategy</strong>
              Use backward planning: Start from the due date and work backwards, scheduling research, drafting, editing, and final review stages. This prevents last-minute rushing and improves quality.
            </div>
            
            <!-- Assignment Form -->
            <div id="assignmentForm" style="display: none; margin-bottom: var(--spacing-xl); padding: var(--spacing-lg); background: var(--bg); border-radius: var(--radius); border: 1px solid var(--border);">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                <div class="form-group">
                  <label for="assignmentName">Assignment Name</label>
                  <input type="text" id="assignmentName" placeholder="Math Chapter 5">
                </div>
                <div class="form-group">
                  <label for="assignmentSubject">Subject</label>
                  <input type="text" id="assignmentSubject" placeholder="Mathematics">
                </div>
                <div class="form-group">
                  <label for="assignmentDueDate">Due Date</label>
                  <input type="date" id="assignmentDueDate">
                </div>
              </div>
              <div class="form-group">
                <label for="assignmentDescription">Description (Optional)</label>
                <textarea id="assignmentDescription" placeholder="Assignment details, requirements, notes..." rows="3"></textarea>
              </div>
              <div style="display: flex; gap: var(--spacing-sm);">
                <button class="btn btn-success" onclick="addAssignment()" style="flex: 1;">‚ûï Add Assignment</button>
                <button class="btn btn-secondary" onclick="hideAssignmentForm()">Cancel</button>
              </div>
            </div>
            
            <div class="assignment-list" id="fullAssignmentList">
              <!-- Full assignment list will appear here -->
            </div>
          </div>
        </div>
      </div>
      
      <!-- Classroom Section -->
      <div id="classroom" class="dashboard-content" style="grid-column: span 12; display: none;">
        <!-- Not in Class View -->
        <div id="notInClassView" class="content-card" style="text-align: center; padding: var(--spacing-2xl);">
          <div class="empty-state">
            <div class="empty-state-icon">üè´</div>
            <div class="empty-state-title">Not in a Classroom</div>
            <div class="empty-state-description" style="margin-bottom: var(--spacing-lg);">
              Join your teacher's classroom to access announcements, resources, and track your progress together.
            </div>
            <div class="pro-tip" style="margin: var(--spacing-lg) 0; max-width: 500px;">
              <strong>üí° Why Join a Classroom?</strong>
              Classrooms provide structure, access to teacher resources, peer motivation through leaderboards, and organized announcements. Students in classrooms show 30% higher engagement.
            </div>
            <button class="btn btn-primary" onclick="showSection('myclasses')" style="padding: 1rem 2rem; font-size: 1.125rem;">
              üéì Join a Classroom
            </button>
            <p style="margin-top: var(--spacing-lg); color: var(--text-muted);">
              Ask your teacher for the class code!
            </p>
          </div>
        </div>
        
        <!-- In Class View -->
        <div id="inClassView" style="display: none;">
          <!-- Class Header -->
          <div class="content-card">
            <div class="class-code-display">
              <div style="font-size: 1rem; opacity: 0.9; letter-spacing: 1px; position: relative; z-index: 1;">CLASS CODE</div>
              <div class="code" id="currentClassCode">LOADING...</div>
              <div style="display: flex; gap: var(--spacing-md); justify-content: center; margin-top: var(--spacing-lg); flex-wrap: wrap; position: relative; z-index: 1;">
                <button class="btn btn-secondary" onclick="copyClassCode()">üìã Copy Code</button>
                <button class="btn btn-danger" onclick="leaveClass()">üö™ Leave Class</button>
                <button class="btn btn-success" onclick="refreshClassroom()">üîÑ Refresh</button>
              </div>
            </div>
          </div>
          
          <!-- Pro Tip -->
          <div class="pro-tip">
            <strong>üí° Active Classroom Participation</strong>
            Regularly check announcements and resources. Engage with the leaderboard - healthy competition increases motivation. Students who actively participate in classrooms complete 40% more assignments.
          </div>
          
          <!-- Announcements -->
          <div class="content-card">
            <div class="content-header">
              <h2>üì¢ Teacher's Announcements</h2>
              <span class="badge" id="announcementCount" style="background: var(--accent); color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.875rem;">0</span>
            </div>
            <div class="content-body">
              <div id="teacherAnnouncements" style="min-height: 200px;">
                <div class="loading">Loading announcements...</div>
              </div>
            </div>
          </div>
          
          <!-- Resources -->
          <div class="content-card">
            <div class="content-header">
              <h2>üìö Learning Resources</h2>
              <span class="badge" id="resourceCount" style="background: var(--success); color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.875rem;">0</span>
            </div>
            <div class="content-body">
              <div id="teacherResources" style="min-height: 200px;">
                <div class="loading">Loading resources...</div>
              </div>
            </div>
          </div>
          
          <!-- Leaderboard -->
          <div class="content-card">
            <div class="content-header">
              <h2>üèÜ Class Leaderboard</h2>
              <button class="btn btn-secondary" onclick="refreshLeaderboard()">üîÑ Refresh</button>
            </div>
            <div class="content-body">
              <div class="leaderboard-container" id="classLeaderboard">
                <div class="loading">Loading leaderboard...</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- My Classes Section -->
      <div id="myclasses" class="dashboard-content" style="grid-column: span 12; display: none;">
        <div class="content-card">
          <div class="content-header">
            <h2>üéì My Classes</h2>
            <button class="btn btn-primary" onclick="showJoinClassForm()">‚ûï Join Class</button>
          </div>
          <div class="content-body">
            <!-- Pro Tip -->
            <div class="pro-tip">
              <strong>üí° Multiple Classes Strategy</strong>
              Join relevant classes for different subjects. Organize your study time by dedicating specific days to each class. Students in 2-3 balanced classes show the best performance outcomes.
            </div>
            
            <!-- Join Class Form -->
            <div id="joinClassForm" style="display: none; margin-bottom: var(--spacing-xl); padding: var(--spacing-lg); background: var(--bg); border-radius: var(--radius); border: 1px solid var(--border);">
              <h3 style="margin-bottom: var(--spacing-lg);">Join a New Class</h3>
              <div class="form-group">
                <label for="joinClassCode">Class Code</label>
                <input type="text" id="joinClassCode" placeholder="Enter 6-digit class code" maxlength="6" style="text-transform: uppercase; font-family: 'Courier New', monospace; letter-spacing: 0.5rem; font-size: 1.5rem; text-align: center;">
              </div>
              <div style="display: flex; gap: var(--spacing-sm);">
                <button class="btn btn-success" onclick="joinClass()" style="flex: 1;">üéì Join Class</button>
                <button class="btn btn-secondary" onclick="hideJoinClassForm()">Cancel</button>
              </div>
            </div>
            
            <div class="classes-grid" id="classesList">
              <!-- Classes will appear here -->
            </div>
            
            <div id="noClassesMessage" class="empty-state" style="display: none;">
              <div class="empty-state-icon">üè´</div>
              <div class="empty-state-title">No Classes Yet</div>
              <div class="empty-state-description">
                Join your first classroom to start tracking your progress with classmates!
              </div>
              <button class="btn btn-primary" onclick="showJoinClassForm()" style="margin-top: var(--spacing-lg);">
                üéì Join Your First Class
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Statistics Section - ENHANCED (not replaced) -->
      <div id="statistics" class="dashboard-content" style="grid-column: span 12; display: none;">
        <div class="content-card">
          <div class="content-header">
            <h2>üìà Learning Statistics</h2>
            <div style="display: flex; gap: var(--spacing-sm);">
              <button class="btn btn-primary" onclick="refreshCharts()">üîÑ Refresh Charts</button>
              <button class="btn btn-secondary" onclick="exportStatistics()">üì• Export Stats</button>
              <button class="btn btn-success" onclick="markStudySession()">üìù Mark Study Session</button>
            </div>
          </div>
          <div class="content-body">
            <!-- Pro Tip -->
            <div class="pro-tip">
              <strong>üí° Data-Driven Learning</strong>
              Review your statistics weekly to identify patterns. Track what study methods work best for you and adjust accordingly. Students who review their data improve 25% faster than those who don't.
            </div>
            
            <!-- NEW: Daily Stats Overview -->
            <div class="daily-stats-grid">
              <div class="daily-stat-card">
                <div class="daily-stat-number" id="todayFocusScore">0%</div>
                <div class="daily-stat-label">Today's Focus Score</div>
                <div class="daily-stat-trend" id="focusTrend">
                  <span>üìà</span>
                  <span>Loading...</span>
                </div>
              </div>
              <div class="daily-stat-card">
                <div class="daily-stat-number" id="todaySessions">0</div>
                <div class="daily-stat-label">Today's Study Sessions</div>
                <div class="daily-stat-trend" id="sessionsTrend">
                  <span>üìä</span>
                  <span>Loading...</span>
                </div>
              </div>
              <div class="daily-stat-card">
                <div class="daily-stat-number" id="todayConsistency">0%</div>
                <div class="daily-stat-label">Consistency Score</div>
                <div class="daily-stat-trend" id="consistencyTrend">
                  <span>üî•</span>
                  <span>Loading...</span>
                </div>
              </div>
            </div>
            
            <!-- Summary Statistics - KEPT -->
            <div class="stat-summary-grid">
              <div class="stat-summary-card">
                <div class="stat-summary-number" id="statsTotalHours">0</div>
                <div class="stat-summary-label">Total Study Hours</div>
                <div class="stat-summary-details" id="statsHoursDetails">Loading...</div>
              </div>
              <div class="stat-summary-card">
                <div class="stat-summary-number" id="statsStreak">0</div>
                <div class="stat-summary-label">Current Streak</div>
                <div class="stat-summary-details" id="statsStreakDetails">Loading...</div>
              </div>
              <div class="stat-summary-card">
                <div class="stat-summary-number" id="statsTaskRate">0%</div>
                <div class="stat-summary-label">Task Completion</div>
                <div class="stat-summary-details" id="statsTaskDetails">Loading...</div>
              </div>
              <div class="stat-summary-card">
                <div class="stat-summary-number" id="statsFocusScore">0%</div>
                <div class="stat-summary-label">Focus Score</div>
                <div class="stat-summary-details" id="statsFocusDetails">Loading...</div>
              </div>
            </div>
            
            <!-- NEW: Daily Statistics Charts -->
            <div class="charts-container">
              <!-- Focus Score Chart -->
              <div class="chart-card">
                <h3>üéØ Daily Focus Score</h3>
                <div class="chart-wrapper">
                  <canvas id="focusChart"></canvas>
                </div>
              </div>
              
              <!-- Study Sessions Chart -->
              <div class="chart-card">
                <h3>üìö Daily Study Sessions</h3>
                <div class="chart-wrapper">
                  <canvas id="sessionsChart"></canvas>
                </div>
              </div>
              
              <!-- Consistency Score Chart -->
              <div class="chart-card">
                <h3>üìä Daily Consistency Score</h3>
                <div class="chart-wrapper">
                  <canvas id="consistencyChart"></canvas>
                </div>
              </div>
              
              <!-- KEEP ALL EXISTING CHARTS -->
              <!-- Study Hours Distribution -->
              <div class="chart-card">
                <h3>üìä Study Hours Distribution</h3>
                <div class="chart-wrapper">
                  <canvas id="hoursChart"></canvas>
                </div>
              </div>
              
              <!-- Task Completion Rate -->
              <div class="chart-card">
                <h3>‚úÖ Task Completion Progress</h3>
                <div class="chart-wrapper">
                  <canvas id="tasksChart"></canvas>
                </div>
              </div>
              
              <!-- Weekly Study Pattern -->
              <div class="chart-card comparison-chart">
                <h3>üìÖ Weekly Study Pattern</h3>
                <div class="chart-wrapper">
                  <canvas id="weeklyChart"></canvas>
                </div>
              </div>
              
              <!-- Assignment Status -->
              <div class="chart-card">
                <h3>üìö Assignment Status</h3>
                <div class="chart-wrapper">
                  <canvas id="assignmentsChart"></canvas>
                </div>
              </div>
              
              <!-- Streak History -->
              <div class="chart-card">
                <h3>üî• Streak History</h3>
                <div class="chart-wrapper">
                  <canvas id="streakChart"></canvas>
                </div>
              </div>
            </div>
            
            <!-- KEEP Detailed Statistics -->
            <div style="margin-top: var(--spacing-xl); padding: var(--spacing-lg); background: var(--bg); border-radius: var(--radius); border: 1px solid var(--border);">
              <h3 style="margin-bottom: var(--spacing-lg);">üìã Detailed Performance Metrics</h3>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-lg);">
                <div>
                  <h4 style="margin-bottom: var(--spacing-sm); color: var(--text-muted);">Productivity Metrics</h4>
                  <div class="stat-row">
                    <span>Average Daily Hours</span>
                    <span class="stat-value" id="avgDailyHours">0</span>
                  </div>
                  <div class="stat-row">
                    <span>Study Sessions</span>
                    <span class="stat-value" id="totalSessions">0</span>
                  </div>
                  <div class="stat-row">
                    <span>Longest Session</span>
                    <span class="stat-value" id="longestSession">0h</span>
                  </div>
                </div>
                <div>
                  <h4 style="margin-bottom: var(--spacing-sm); color: var(--text-muted);">Task Metrics</h4>
                  <div class="stat-row">
                    <span>Avg. Tasks/Day</span>
                    <span class="stat-value" id="avgTasksPerDay">0</span>
                  </div>
                  <div class="stat-row">
                    <span>Fastest Completion</span>
                    <span class="stat-value" id="fastestCompletion">0h</span>
                  </div>
                  <div class="stat-row">
                    <span>Active Tasks</span>
                    <span class="stat-value" id="activeTasksCount">0</span>
                  </div>
                </div>
                <div>
                  <h4 style="margin-bottom: var(--spacing-sm); color: var(--text-muted);">Achievement Metrics</h4>
                  <div class="stat-row">
                    <span>Total Points</span>
                    <span class="stat-value" id="totalPoints">0</span>
                  </div>
                  <div class="stat-row">
                    <span>Longest Streak</span>
                    <span class="stat-value" id="longestStreak">0</span>
                  </div>
                  <div class="stat-row">
                    <span>Consistency Score</span>
                    <span class="stat-value" id="consistencyScore">0%</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Tools Section -->
      <div id="tools" class="dashboard-content" style="grid-column: span 12; display: none;">
        <div class="content-card">
          <div class="content-header">
            <h2>üõ†Ô∏è Study Tools</h2>
          </div>
          <div class="content-body">
            <!-- Pro Tip -->
            <div class="pro-tip">
              <strong>üí° Tool Integration</strong>
              Combine different tools for maximum effectiveness. Use Pomodoro timer for focus, flashcards for memorization, and habit tracker for consistency. Integrated tool users show 35% better results.
            </div>
            
            <div class="tools-grid">
              <div class="tool-item" onclick="window.open('https://mairakhancontact-sudo.github.io/javascript-projects/ai-tic-tac-toe.html', '_blank')">
                <div class="tool-icon">üéÆ</div>
                <div class="tool-name">AI Tic Tac Toe</div>
                <div class="tool-desc">Challenge AI in this classic game</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://mairakhancontact-sudo.github.io/javascript-projects/countdown-timer.html', '_blank')">
                <div class="tool-icon">‚è≥</div>
                <div class="tool-name">Countdown Timer</div>
                <div class="tool-desc">Track study sessions and breaks</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://mairakhancontact-sudo.github.io/javascript-projects/habit-tracker.html', '_blank')">
                <div class="tool-icon">üìä</div>
                <div class="tool-name">Habit Tracker</div>
                <div class="tool-desc">Build and maintain good habits</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://mairakhancontact-sudo.github.io/javascript-projects/todolist.html', '_blank')">
                <div class="tool-icon">üìù</div>
                <div class="tool-name">To-Do List</div>
                <div class="tool-desc">Advanced task management</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://mairakhancontact-sudo.github.io/javascript-projects/notesapp.html', '_blank')">
                <div class="tool-icon">üìí</div>
                <div class="tool-name">Notes App</div>
                <div class="tool-desc">Take organized notes</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://mairakhancontact-sudo.github.io/javascript-projects/numberguess.html', '_blank')">
                <div class="tool-icon">üéØ</div>
                <div class="tool-name">Number Guess</div>
                <div class="tool-desc">Brain training game</div>
              </div>
              
              <div class="tool-item" onclick="window.open('pomodoro.html', '_blank')">
                <div class="tool-icon">üçÖ</div>
                <div class="tool-name">Pomodoro Timer</div>
                <div class="tool-desc">Boost productivity with intervals</div>
              </div>
              
              <div class="tool-item" onclick="window.open('flashcard-generator.html', '_blank')">
                <div class="tool-icon">üìá</div>
                <div class="tool-name">Flashcards</div>
                <div class="tool-desc">Create and study flashcards</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- AI Help Section -->
      <div id="ai" class="dashboard-content" style="grid-column: span 12; display: none;">
        <div class="content-card">
          <div class="content-header">
            <h2>ü§ñ AI Learning Resources</h2>
          </div>
          <div class="content-body">
            <!-- Pro Tip -->
            <div class="pro-tip">
              <strong>üí° AI Learning Strategy</strong>
              Use AI to explain difficult concepts, generate practice questions, or get writing feedback. Combine AI explanations with traditional resources for comprehensive understanding.
            </div>
            
            <div class="tools-grid">
              <div class="tool-item" onclick="window.open('https://chat.openai.com', '_blank')">
                <div class="tool-icon">üí¨</div>
                <div class="tool-name">ChatGPT</div>
                <div class="tool-desc">AI assistant for learning and research</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://gemini.google.com', '_blank')">
                <div class="tool-icon">üîÆ</div>
                <div class="tool-name">Google Gemini</div>
                <div class="tool-desc">AI-powered research and answers</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://www.perplexity.ai', '_blank')">
                <div class="tool-icon">üîç</div>
                <div class="tool-name">Perplexity AI</div>
                <div class="tool-desc">Answer engine with citations</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://www.khanacademy.org', '_blank')">
                <div class="tool-icon">üéì</div>
                <div class="tool-name">Khan Academy</div>
                <div class="tool-desc">Free online courses and lessons</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://www.coursera.org', '_blank')">
                <div class="tool-icon">üèõÔ∏è</div>
                <div class="tool-name">Coursera</div>
                <div class="tool-desc">University courses and certificates</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://www.youtube.com', '_blank')">
                <div class="tool-icon">üì∫</div>
                <div class="tool-name">YouTube</div>
                <div class="tool-desc">Educational videos and tutorials</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://quizlet.com', '_blank')">
                <div class="tool-icon">üß†</div>
                <div class="tool-name">Quizlet</div>
                <div class="tool-desc">Study tools and flashcards</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://duolingo.com', '_blank')">
                <div class="tool-icon">ü¶â</div>
                <div class="tool-name">Duolingo</div>
                <div class="tool-desc">Language learning made fun</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Profile Section -->
      <div id="profile" class="dashboard-content" style="grid-column: span 12; display: none;">
        <div class="content-card">
          <div class="content-header">
            <h2>üë§ Profile Settings</h2>
          </div>
          <div class="content-body">
            <div style="max-width: 600px; margin: 0 auto;">
              <!-- Pro Tip -->
              <div class="pro-tip">
                <strong>üí° Personalized Learning</strong>
                Customize your preferences based on your learning style. Morning person? Schedule study then. Visual learner? Use more diagrams and charts in your notes.
              </div>
              
              <div class="form-group">
                <label for="profileName">Your Name</label>
                <input type="text" id="profileName" placeholder="Enter your name">
              </div>
              <div class="form-group">
                <label for="profileEmail">Email (Optional)</label>
                <input type="email" id="profileEmail" placeholder="your@email.com">
              </div>
              <div class="form-group">
                <label for="profileBio">Bio</label>
                <textarea id="profileBio" placeholder="Tell us about yourself..." rows="4"></textarea>
              </div>
              <div class="form-group">
                <label>Study Preferences</label>
                <div style="display: flex; gap: var(--spacing-md); flex-wrap: wrap; margin-top: var(--spacing-sm);">
                  <label style="display: flex; align-items: center; gap: var(--spacing-xs);">
                    <input type="checkbox" id="prefPomodoro"> Pomodoro Timer
                  </label>
                  <label style="display: flex; align-items: center; gap: var(--spacing-xs);">
                    <input type="checkbox" id="prefReminders"> Study Reminders
                  </label>
                  <label style="display: flex; align-items: center; gap: var(--spacing-xs);">
                    <input type="checkbox" id="prefLeaderboard"> Show Leaderboard
                  </label>
                </div>
              </div>
              <button class="btn-submit" onclick="saveProfileSettings()" style="margin-top: var(--spacing-lg);">
                üíæ Save Profile Settings
              </button>
              
              <div style="margin-top: var(--spacing-xl); padding-top: var(--spacing-xl); border-top: 1px solid var(--border);">
                <h3>üìä Data Management</h3>
                <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-md);">
                  <button class="btn btn-warning" onclick="exportData()">üì§ Export All Data</button>
                  <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
                </div>
                <p style="font-size: 0.875rem; color: var(--text-muted); margin-top: var(--spacing-sm);">
                  Export your data for backup or clear all data to start fresh.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
    </div>
  </main>
</div>

<script>
// ========== FIREBASE CONFIGURATION ==========
const firebaseConfig = {
    apiKey: "AIzaSyBAIPxgXPZmGdPvB98TLFRfTAClgXWEIM0",
    authDomain: "student-teacher-app-4e7c9.firebaseapp.com",
    databaseURL: "https://student-teacher-app-4e7c9-default-rtdb.firebaseio.com",
    projectId: "student-teacher-app-4e7c9",
    storageBucket: "student-teacher-app-4e7c9.firebasestorage.app",
    messagingSenderId: "737621420458",
    appId: "1:737621420458:web:74c873869a1a47c2ce23d3"
};

// ========== GLOBAL VARIABLES ==========
let currentUser = null;
let currentUserId = null;
let currentUserName = "Student";
let database = null;
let auth = null;
let userClasses = [];
let currentClassCode = null;
let selectedClassIndex = 0;

let studyData = {
    streak: 0,
    lastStudyDate: "",
    totalMinutes: 0,
    totalStudyDays: 0,
    totalStudyHours: 0,
    studySessions: [],
    weeklyPattern: [0, 0, 0, 0, 0, 0, 0],
    streakHistory: [],
    streakMilestones: [3, 7, 14, 30, 60, 90],
    currentMilestone: 0,
    // NEW: Daily statistics tracking
    dailyStats: [],
    focusScores: [],
    consistencyScores: []
};

let tasks = [];
let assignments = [];
let currentTaskFilter = 'all';
let currentSection = 'dashboard';
let selectedPriority = 'urgent'; // Default priority

// Chart instances
let hoursChart = null;
let tasksChart = null;
let weeklyChart = null;
let assignmentsChart = null;
let streakChart = null;
// NEW: Daily statistics charts
let focusChart = null;
let sessionsChart = null;
let consistencyChart = null;

// Chart auto-refresh interval
let chartRefreshInterval = null;

// ========== INSPIRING QUOTES DATABASE ==========
const inspiringQuotes = [
    { text: "Education is the most powerful weapon which you can use to change the world.", author: "Nelson Mandela" },
    { text: "The beautiful thing about learning is that no one can take it away from you.", author: "B.B. King" },
    { text: "Don't let what you cannot do interfere with what you can do.", author: "John Wooden" },
    { text: "The more that you read, the more things you will know. The more that you learn, the more places you'll go.", author: "Dr. Seuss" },
    { text: "The capacity to learn is a gift; the ability to learn is a skill; the willingness to learn is a choice.", author: "Brian Herbert" },
    { text: "Knowledge is power. Information is liberating. Education is the premise of progress, in every society, in every family.", author: "Kofi Annan" },
    { text: "The roots of education are bitter, but the fruit is sweet.", author: "Aristotle" },
    { text: "Education is not preparation for life; education is life itself.", author: "John Dewey" },
    { text: "The mind is not a vessel to be filled, but a fire to be kindled.", author: "Plutarch" },
    { text: "Live as if you were to die tomorrow. Learn as if you were to live forever.", author: "Mahatma Gandhi" },
    { text: "You don't have to be great to start, but you have to start to be great.", author: "Zig Ziglar" },
    { text: "The only person who is educated is the one who has learned how to learn and change.", author: "Carl Rogers" },
    { text: "Education is the key to unlocking the world, a passport to freedom.", author: "Oprah Winfrey" },
    { text: "Learning is a treasure that will follow its owner everywhere.", author: "Chinese Proverb" },
    { text: "The expert in anything was once a beginner.", author: "Helen Hayes" },
    { text: "Success is not the key to happiness. Happiness is the key to success. If you love what you are doing, you will be successful.", author: "Albert Schweitzer" },
    { text: "The future belongs to those who believe in the beauty of their dreams.", author: "Eleanor Roosevelt" },
    { text: "What lies behind us and what lies before us are tiny matters compared to what lies within us.", author: "Ralph Waldo Emerson" },
    { text: "You are never too old to set another goal or to dream a new dream.", author: "C.S. Lewis" },
    { text: "Believe you can and you're halfway there.", author: "Theodore Roosevelt" },
    { text: "The only way to do great work is to love what you do.", author: "Steve Jobs" },
    { text: "Don't watch the clock; do what it does. Keep going.", author: "Sam Levenson" },
    { text: "Success is not final, failure is not fatal: it is the courage to continue that counts.", author: "Winston Churchill" },
    { text: "The future depends on what you do today.", author: "Mahatma Gandhi" },
    { text: "You miss 100% of the shots you don't take.", author: "Wayne Gretzky" },
    { text: "It does not matter how slowly you go as long as you do not stop.", author: "Confucius" },
    { text: "The secret of getting ahead is getting started.", author: "Mark Twain" },
    { text: "Optimism is the faith that leads to achievement. Nothing can be done without hope and confidence.", author: "Helen Keller" },
    { text: "Your time is limited, don't waste it living someone else's life.", author: "Steve Jobs" },
    { text: "The only limit to our realization of tomorrow will be our doubts of today.", author: "Franklin D. Roosevelt" },
    { text: "Start where you are. Use what you have. Do what you can.", author: "Arthur Ashe" },
    { text: "I can't change the direction of the wind, but I can adjust my sails to always reach my destination.", author: "Jimmy Dean" },
    { text: "You are braver than you believe, stronger than you seem, and smarter than you think.", author: "A.A. Milne" },
    { text: "The difference between a successful person and others is not a lack of strength, not a lack of knowledge, but rather a lack in will.", author: "Vince Lombardi" },
    { text: "The harder I work, the more luck I seem to have.", author: "Thomas Jefferson" },
    { text: "Don't be pushed around by the fears in your mind. Be led by the dreams in your heart.", author: "Roy T. Bennett" },
    { text: "Strength doesn't come from what you can do. It comes from overcoming the things you once thought you couldn't.", author: "Rikki Rogers" },
    { text: "Every accomplishment starts with the decision to try.", author: "John F. Kennedy" },
    { text: "You don't have to see the whole staircase, just take the first step.", author: "Martin Luther King Jr." },
    { text: "The only thing standing between you and your goal is the story you keep telling yourself as to why you can't achieve it.", author: "Jordan Belfort" },
    { text: "Small daily improvements are the key to staggering long-term results.", author: "Darren Hardy" },
    { text: "The journey of a thousand miles begins with one step.", author: "Lao Tzu" },
    { text: "What you get by achieving your goals is not as important as what you become by achieving your goals.", author: "Zig Ziglar" },
    { text: "Your potential is endless. Go do what you were created to do.", author: "Unknown" },
    { text: "The moment you give up is the moment you let someone else win.", author: "Kobe Bryant" },
    { text: "Challenges are what make life interesting and overcoming them is what makes life meaningful.", author: "Joshua J. Marine" },
    { text: "Don't limit your challenges. Challenge your limits.", author: "Unknown" },
    { text: "The pain of discipline weighs ounces, the pain of regret weighs tons.", author: "Jim Rohn" },
    { text: "Success is stumbling from failure to failure with no loss of enthusiasm.", author: "Winston Churchill" },
    { text: "You are never too old to set another goal or to dream a new dream.", author: "C.S. Lewis" }
];

// ========== INSPIRING STORIES DATABASE ==========
const inspiringStories = [
    {
        id: 1,
        name: "Albert Einstein",
        icon: "üß†",
        quote: "Imagination is more important than knowledge.",
        story: "Albert Einstein, one of the greatest physicists of all time, faced numerous struggles in his early life. He didn't speak until he was four years old and was considered a slow learner by his teachers. He failed his first entrance exam to the Swiss Federal Polytechnic School. Despite these early challenges, Einstein's curiosity and persistence led him to develop the theory of relativity, which revolutionized our understanding of space, time, and gravity. He was awarded the Nobel Prize in Physics in 1921.",
        struggles: [
            "Late development in speech and learning",
            "Failed university entrance exam",
            "Worked as a patent clerk while developing groundbreaking theories",
            "Faced skepticism from the scientific community"
        ],
        lessons: "Never give up on your curiosity. What others see as weaknesses might be your greatest strengths."
    },
    {
        id: 2,
        name: "Oprah Winfrey",
        icon: "üé§",
        quote: "Turn your wounds into wisdom.",
        story: "Oprah Winfrey overcame a childhood of poverty and abuse to become one of the most influential media personalities in the world. Born into poverty in rural Mississippi, she was molested by relatives and became pregnant at 14 (the child died in infancy). Despite these traumatic experiences, she excelled in school and won a scholarship to Tennessee State University. Her breakthrough came when she moved to Chicago to host a morning talk show, which eventually became 'The Oprah Winfrey Show' - the highest-rated talk show in American history.",
        struggles: [
            "Poverty and childhood abuse",
            "Teen pregnancy and loss of child",
            "Racial and gender discrimination",
            "Battled with weight and self-esteem issues"
        ],
        lessons: "Your past doesn't define your future. Use your experiences to empower yourself and others."
    },
    {
        id: 3,
        name: "Stephen Hawking",
        icon: "üåå",
        quote: "However difficult life may seem, there is always something you can do and succeed at.",
        story: "Stephen Hawking was diagnosed with ALS (amyotrophic lateral sclerosis) at age 21 and given just two years to live. Despite being confined to a wheelchair and losing his ability to speak, he became one of the most brilliant theoretical physicists of our time. Using a speech-generating device, he continued his research on black holes and the origins of the universe. His book 'A Brief History of Time' sold over 25 million copies worldwide, making complex scientific concepts accessible to the general public.",
        struggles: [
            "Diagnosed with ALS at 21",
            "Gradual loss of mobility and speech",
            "Confined to wheelchair for most of his life",
            "Medical complications including pneumonia"
        ],
        lessons: "Physical limitations cannot constrain the human mind. Focus on what you can do, not what you can't."
    },
    {
        id: 4,
        name: "J.K. Rowling",
        icon: "‚úçÔ∏è",
        quote: "Rock bottom became the solid foundation on which I rebuilt my life.",
        story: "Before publishing Harry Potter, J.K. Rowling was a single mother living on welfare in Edinburgh, Scotland. She wrote the first Harry Potter book in cafes while her baby daughter slept. The manuscript was rejected by 12 publishers before Bloomsbury accepted it. Today, the Harry Potter series has sold over 500 million copies worldwide, making Rowling one of the most successful authors in history. She went from being on government assistance to becoming a billionaire (though she has since donated much of her wealth to charity).",
        struggles: [
            "Single mother living on welfare",
            "Clinical depression and suicidal thoughts",
            "12 publishers rejected Harry Potter",
            "Struggled with poverty for years"
        ],
        lessons: "Failure is not permanent. Persistence can turn your biggest dreams into reality."
    },
    {
        id: 5,
        name: "Thomas Edison",
        icon: "üí°",
        quote: "I have not failed. I've just found 10,000 ways that won't work.",
        story: "Thomas Edison, one of America's greatest inventors, was told by his teachers that he was 'too stupid to learn anything.' He was fired from his first two jobs for being 'non-productive.' Despite these setbacks, he went on to hold 1,093 patents, including the phonograph, the motion picture camera, and perhaps most famously, the practical electric light bulb. His invention of the light bulb required thousands of experiments with different materials before finding one that worked.",
        struggles: [
            "Teachers said he was 'too stupid to learn'",
            "Fired from early jobs",
            "Thousands of failed experiments",
            "Lost his hearing as a child"
        ],
        lessons: "Persistence and learning from failure are keys to innovation and success."
    },
    {
        id: 6,
        name: "Malala Yousafzai",
        icon: "üìö",
        quote: "One child, one teacher, one book, one pen can change the world.",
        story: "Malala Yousafzai was shot in the head by the Taliban at age 15 for advocating for girls' education in Pakistan. She survived the attack and continued her activism, becoming the youngest-ever Nobel Prize laureate at age 17. Her recovery involved multiple surgeries and rehabilitation in the UK. Today, she continues to fight for education rights through the Malala Fund, which supports education programs around the world.",
        struggles: [
            "Shot by Taliban at age 15",
            "Faced death threats for advocating education",
            "Multiple surgeries and long recovery",
            "Forced to leave her home country"
        ],
        lessons: "Courage means standing up for what you believe in, even in the face of extreme danger."
    },
    {
        id: 7,
        name: "Walt Disney",
        icon: "üè∞",
        quote: "All our dreams can come true if we have the courage to pursue them.",
        story: "Walt Disney was fired from a newspaper for 'lacking imagination' and 'having no good ideas.' His first animation company went bankrupt. He was turned down 302 times before getting financing for Disney World. Despite these failures, he created Mickey Mouse and built the Disney empire, which has brought joy to millions of people worldwide. His theme parks and films continue to be beloved by generations.",
        struggles: [
            "Fired from newspaper for 'no imagination'",
            "First animation company bankrupt",
            "302 rejections for Disney World financing",
            "Struggled with financial problems"
        ],
        lessons: "Believe in your vision even when others don't. Persistence can create magic."
    },
    {
        id: 8,
        name: "Bethany Hamilton",
        icon: "üèÑ‚Äç‚ôÄÔ∏è",
        quote: "Courage doesn't mean you don't get afraid. Courage means you don't let fear stop you.",
        story: "At age 13, professional surfer Bethany Hamilton lost her left arm to a shark attack. Just one month after the attack, she returned to surfing. She went on to win her first national surfing title two years later and became a professional surfer. Her story was made into the movie 'Soul Surfer.' She continues to surf competitively and inspires people worldwide with her determination.",
        struggles: [
            "Lost arm in shark attack at 13",
            "Learned to surf with one arm",
            "Faced physical and emotional challenges",
            "Overcame fear of returning to ocean"
        ],
        lessons: "Life's challenges can become opportunities for growth and inspiration."
    }
];

// ========== DATA PERSISTENCE HELPER ==========
function persistData() {
    try {
        const dataToSave = {
            version: "2.2",
            lastSaved: new Date().toISOString(),
            userId: currentUserId,
            userName: currentUserName,
            studyData: studyData,
            tasks: tasks,
            assignments: assignments,
            userClasses: userClasses,
            currentClassCode: currentClassCode,
            selectedClassIndex: selectedClassIndex,
            currentSection: currentSection
        };
        
        localStorage.setItem('studentPersistentData', JSON.stringify(dataToSave));
        console.log("üíæ Data persisted to localStorage");
    } catch (e) {
        console.error("Error persisting data:", e);
    }
}

function loadPersistedData() {
    try {
        const savedData = localStorage.getItem('studentPersistentData');
        if (savedData) {
            const data = JSON.parse(savedData);
            
            // Check version compatibility
            if (data.version && (data.version === "2.2" || data.version === "2.1" || data.version === "2.0")) {
                console.log("üìÇ Loading persisted data version:", data.version);
                
                // Load study data
                if (data.studyData) {
                    studyData = data.studyData;
                    console.log("üìä Loaded study data:", {
                        streak: studyData.streak,
                        hours: studyData.totalStudyHours,
                        sessions: studyData.studySessions?.length || 0
                    });
                }
                
                // Load tasks
                if (data.tasks) {
                    tasks = data.tasks;
                    console.log("üìù Loaded tasks:", tasks.length);
                }
                
                // Load assignments
                if (data.assignments) {
                    assignments = data.assignments;
                    console.log("üìö Loaded assignments:", assignments.length);
                }
                
                // Load classes
                if (data.userClasses) {
                    userClasses = data.userClasses;
                    console.log("üè´ Loaded classes:", userClasses.length);
                }
                
                // Load current class
                if (data.currentClassCode) {
                    currentClassCode = data.currentClassCode;
                }
                
                if (data.selectedClassIndex !== undefined) {
                    selectedClassIndex = data.selectedClassIndex;
                }
                
                // Load current section
                if (data.currentSection) {
                    currentSection = data.currentSection;
                }
                
                // Load user info
                if (data.userName) {
                    currentUserName = data.userName;
                }
                
                if (data.userId && data.userId.startsWith('student_')) {
                    currentUserId = data.userId;
                    localStorage.setItem('studentUserId', currentUserId);
                    console.log("üë§ Loaded user ID from persisted data:", currentUserId);
                }
                
                console.log("‚úÖ Persisted data loaded successfully");
                return true;
            } else {
                console.log("‚ö†Ô∏è No compatible version found in persisted data");
            }
        }
    } catch (e) {
        console.error("‚ùå Error loading persisted data:", e);
    }
    
    console.log("‚ö†Ô∏è No persisted data found, using defaults");
    return false;
}
// ========== FIREBASE DATABASE HELPERS ==========
function getDatabaseRef(path) {
    if (!database) return null;
    return database.ref(path);
}

async function firebaseGet(refPath) {
    if (!database || !currentUser) {
        console.log("‚ö†Ô∏è Firebase not available or user not authenticated, using localStorage");
        return null;
    }
    
    try {
        const ref = getDatabaseRef(refPath);
        const snapshot = await ref.once('value');
        return snapshot.exists() ? snapshot.val() : null;
    } catch (error) {
        console.error(`‚ùå Firebase get error at ${refPath}:`, error);
        return null;
    }
}

async function firebaseSet(refPath, data) {
    if (!database || !currentUser) {
        console.log("‚ö†Ô∏è Firebase not available or user not authenticated, data saved locally only");
        return false;
    }
    
    try {
        const ref = getDatabaseRef(refPath);
        await ref.set(data);
        return true;
    } catch (error) {
        console.error(`‚ùå Firebase set error at ${refPath}:`, error);
        return false;
    }
}

async function firebaseUpdate(refPath, data) {
    if (!database || !currentUser) {
        console.log("‚ö†Ô∏è Firebase not available or user not authenticated, data saved locally only");
        return false;
    }
    
    try {
        const ref = getDatabaseRef(refPath);
        await ref.update(data);
        return true;
    } catch (error) {
        console.error(`‚ùå Firebase update error at ${refPath}:`, error);
        return false;
    }
}

async function firebaseRemove(refPath) {
    if (!database || !currentUser) {
        console.log("‚ö†Ô∏è Firebase not available or user not authenticated");
        return false;
    }
    
    try {
        const ref = getDatabaseRef(refPath);
        await ref.remove();
        return true;
    } catch (error) {
        console.error(`‚ùå Firebase remove error at ${refPath}:`, error);
        return false;
    }
}

// ========== INITIALIZATION ==========
document.addEventListener('DOMContentLoaded', async function() {
    console.log("üéì Student Mode initializing...");
    
    // FIRST: Load persisted data BEFORE Firebase initialization
    const dataLoaded = loadPersistedData();
    console.log("üìÇ Data loaded from localStorage:", dataLoaded);
    
    try {
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        database = firebase.database();
        auth = firebase.auth();
        
        console.log("‚úÖ Firebase initialized successfully");
        
        // Check if we have a user ID from persisted data
        if (!currentUserId) {
            // Try to get from localStorage
            const savedUserId = localStorage.getItem('studentUserId');
            if (savedUserId && savedUserId.startsWith('student_')) {
                currentUserId = savedUserId;
                console.log("üÜî Loaded user ID from localStorage:", currentUserId);
            } else {
                // Generate a new persistent user ID
                currentUserId = `student_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                localStorage.setItem('studentUserId', currentUserId);
                console.log("üÜï Generated new persistent user ID:", currentUserId);
            }
        }
        
        // Set user name from persisted data or localStorage
        const savedName = localStorage.getItem('studentName');
        if (savedName) {
            currentUserName = savedName;
        }
        
        console.log("üë§ Current user info:", {
            id: currentUserId,
            name: currentUserName,
            streak: studyData.streak,
            hours: studyData.totalStudyHours
        });
        
        try {
            // Try anonymous authentication
            console.log("üîê Attempting anonymous sign-in...");
            const userCredential = await auth.signInAnonymously();
            currentUser = userCredential.user;
            
            console.log("‚úÖ Anonymous authentication successful");
            console.log("üìù Firebase UID:", currentUser.uid);
            console.log("üìù Our Student ID:", currentUserId);
            
            // Save both UIDs for reference
            localStorage.setItem('studentFirebaseUid', currentUser.uid);
            
        } catch (authError) {
            console.error("‚ùå Anonymous sign-in failed:", authError);
            console.log("‚ö†Ô∏è Using offline mode only");
            showNotification("‚ö†Ô∏è Working in offline mode. Data saved locally.", "warning");
        }
        
        // Initialize the app
        initUI();
        loadAllData();
        setupEventListeners();
        setupAutoSave();
        setupChartAutoRefresh();
        
        // Update UI with loaded data
        updateUI();
        updateStreakUI();
        updateAllStatistics();
        
        console.log("üéì Student Mode ready!");
        console.log("üìä Loaded data:", {
            streak: studyData.streak,
            hours: studyData.totalStudyHours,
            tasks: tasks.length,
            assignments: assignments.length,
            classes: userClasses.length
        });
        
        setTimeout(() => {
            showNotification(`Welcome back, ${currentUserName}! üìö Streak: ${studyData.streak} days`, "success");
        }, 1000);
        
    } catch (error) {
        console.error("‚ùå Initialization error:", error);
        
        // Fallback: Ensure we have a user ID even if everything fails
        if (!currentUserId) {
            const savedUserId = localStorage.getItem('studentUserId');
            if (savedUserId && savedUserId.startsWith('student_')) {
                currentUserId = savedUserId;
            } else {
                currentUserId = `student_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                localStorage.setItem('studentUserId', currentUserId);
            }
        }
        
        // Initialize in offline mode
        initUI();
        loadAllData();
        setupEventListeners();
        setupAutoSave();
        setupChartAutoRefresh();
        
        updateUI();
        updateStreakUI();
        updateAllStatistics();
        
        showNotification("‚ö†Ô∏è Working in offline mode. Data saved locally.", "warning");
    }
});
// ========== AUTO-SAVE SYSTEM ==========
function setupAutoSave() {
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'hidden') {
            persistData();
        }
    });
    
    window.addEventListener('beforeunload', function() {
        persistData();
    });
    
    setInterval(persistData, 30000);
    
    console.log("üíæ Auto-save system initialized");
}

// ========== CHART AUTO-REFRESH ==========
function setupChartAutoRefresh() {
    if (chartRefreshInterval) {
        clearInterval(chartRefreshInterval);
    }
    
    chartRefreshInterval = setInterval(() => {
        if (currentSection === 'statistics') {
            console.log("üîÑ Auto-refreshing charts...");
            refreshChartsSilently();
        }
    }, 300000);
    
    console.log("üìà Chart auto-refresh system initialized");
}

function refreshChartsSilently() {
    if (currentSection === 'statistics') {
        updateCharts();
        updateSyncStatus("Charts updated", "success");
    }
}

// ========== USER DATA MANAGEMENT ==========
function loadUserData() {
    const savedUserId = localStorage.getItem('studentUserId');
    if (savedUserId && savedUserId.startsWith('student_')) {
        currentUserId = savedUserId;
    } else if (!currentUserId) {
        currentUserId = `student_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        localStorage.setItem('studentUserId', currentUserId);
    }
    
    currentUserName = localStorage.getItem('studentName') || 'Student';
    
    const savedClasses = localStorage.getItem('studentUserClasses');
    if (savedClasses) {
        try {
            userClasses = JSON.parse(savedClasses);
            console.log(`üìö Loaded ${userClasses.length} classes from localStorage`);
            
            if (userClasses.length > 0 && !currentClassCode) {
                currentClassCode = userClasses[0].code;
                selectedClassIndex = 0;
            }
        } catch (e) {
            console.error("Error parsing user classes:", e);
            userClasses = [];
        }
    }
    
    const nameField = document.getElementById('studentName');
    if (nameField) nameField.value = currentUserName;
    
    const profileNameField = document.getElementById('profileName');
    if (profileNameField) profileNameField.value = currentUserName;
}

function saveUserData() {
    // ALWAYS save the current user ID
    if (currentUserId) {
        localStorage.setItem('studentUserId', currentUserId);
    }
    
    if (currentUserName) {
        localStorage.setItem('studentName', currentUserName);
    }
    
    if (userClasses.length > 0) {
        localStorage.setItem('studentUserClasses', JSON.stringify(userClasses));
    }
    
    // Also save to the persisted data system
    persistData();
    
    console.log("üíæ User data saved:", {
        userId: currentUserId,
        name: currentUserName,
        classesCount: userClasses.length
    });
}

// ========== IMPROVED STREAK SYSTEM ==========
function updateStreakUI() {
    const streakNumber = document.getElementById('streakNumber');
    const streakLabel = document.getElementById('streakLabel');
    const streakProgressFill = document.getElementById('streakProgressFill');
    const streakMilestones = document.getElementById('streakMilestones');
    const nextMilestone = document.getElementById('nextMilestone');
    
    if (!streakNumber) return;
    
    streakNumber.textContent = studyData.streak;
    
    let streakEmoji = "üìà";
    if (studyData.streak >= 30) streakEmoji = "üèÜ";
    else if (studyData.streak >= 14) streakEmoji = "üî•";
    else if (studyData.streak >= 7) streakEmoji = "‚ú®";
    else if (studyData.streak >= 3) streakEmoji = "‚≠ê";
    
    streakLabel.textContent = `${streakEmoji} ${studyData.streak} DAY STREAK`;
    
    let nextMilestoneDay = studyData.streakMilestones.find(milestone => milestone > studyData.streak) || studyData.streakMilestones[studyData.streakMilestones.length - 1];
    let currentMilestoneIndex = studyData.streakMilestones.findIndex(milestone => milestone > studyData.streak) - 1;
    
    if (currentMilestoneIndex < 0) {
        currentMilestoneIndex = studyData.streakMilestones.length - 1;
    }
    
    let progressPercentage = 0;
    if (nextMilestoneDay) {
        progressPercentage = (studyData.streak / nextMilestoneDay) * 100;
        if (progressPercentage > 100) progressPercentage = 100;
    }
    streakProgressFill.style.width = `${progressPercentage}%`;
    
    let milestonesHTML = '';
    studyData.streakMilestones.forEach((milestone, index) => {
        const isActive = studyData.streak >= milestone;
        const isCurrent = index === currentMilestoneIndex;
        milestonesHTML += `<div class="milestone ${isActive ? 'active' : ''} ${isCurrent ? 'current' : ''}" title="${milestone} days"></div>`;
    });
    streakMilestones.innerHTML = milestonesHTML;
    
    if (nextMilestoneDay) {
        const daysLeft = nextMilestoneDay - studyData.streak;
        nextMilestone.textContent = `${nextMilestoneDay} days (${daysLeft} to go)`;
    } else {
        nextMilestone.textContent = "Maximum milestone reached! üéâ";
    }
    
    updateStreakButton();
}

function getTodayKey() {
    const today = new Date();
    return today.toDateString();
}

function isConsecutiveDay(lastDateString, currentDateString) {
    if (!lastDateString) return false;
    
    const lastDate = new Date(lastDateString);
    const currentDate = new Date(currentDateString);
    
    const diffTime = Math.abs(currentDate - lastDate);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    return diffDays === 1;
}

async function markStudyToday() {
    console.log("üî• markStudyToday() called");
    
    const todayKey = getTodayKey();
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayKey = yesterday.toDateString();
    
    if (studyData.lastStudyDate === todayKey) {
        showNotification("You've already marked study for today! Come back tomorrow.", "info");
        updateStreakButton();
        return;
    }
    
    let message = "";
    let messageType = "success";
    
    if (!studyData.lastStudyDate) {
        studyData.streak = 1;
        message = "üéâ First study day! Starting your streak!";
    } else if (studyData.lastStudyDate === yesterdayKey || isConsecutiveDay(studyData.lastStudyDate, todayKey)) {
        studyData.streak += 1;
        message = `üî• Streak continued! Now at ${studyData.streak} days!`;
        
        const milestoneAchieved = studyData.streakMilestones.find(milestone => milestone === studyData.streak);
        if (milestoneAchieved) {
            message = `üèÜ MILESTONE ACHIEVED! ${milestoneAchieved}-day streak! Keep going!`;
            messageType = "warning";
        }
    } else {
        const lastDate = new Date(studyData.lastStudyDate);
        const today = new Date();
        const diffTime = Math.abs(today - lastDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays > 1) {
            message = `‚è∞ You missed ${diffDays - 1} day(s). Starting new streak.`;
            messageType = "warning";
        } else {
            message = "üîÑ Starting new streak today!";
        }
        studyData.streak = 1;
    }
    
    studyData.lastStudyDate = todayKey;
    studyData.totalStudyDays += 1;
    
    studyData.streakHistory.push({
        date: todayKey,
        streak: studyData.streak
    });
    
    const dayOfWeek = new Date().getDay();
    studyData.weeklyPattern[dayOfWeek] = (studyData.weeklyPattern[dayOfWeek] || 0) + 1;
    
    persistData();
    updateUI();
    updateSidebarStats();
    updateStreakUI();
    
    updateSyncStatus("Saving to all classes...", "syncing");
    await saveStudyDataToFirebase();
    
    showNotification(message, messageType);
    
    if (currentSection === 'statistics') {
        updateCharts();
    }
    
    setTimeout(() => {
        updateSyncStatus("Saved successfully!", "success");
    }, 1500);
}

function updateStreakButton() {
    const streakBtn = document.getElementById('streakButton');
    const streakMessage = document.getElementById('streakMessage');
    const lastStudyDate = document.getElementById('lastStudyDate');
    
    if (!streakBtn) return;
    
    const todayKey = getTodayKey();
    
    if (studyData.lastStudyDate === todayKey) {
        streakBtn.disabled = true;
        streakBtn.innerHTML = '<span>‚úÖ Already Marked Today</span>';
        streakBtn.style.background = 'var(--success)';
        streakBtn.style.opacity = '0.8';
        
        if (streakMessage) {
            streakMessage.textContent = `Come back tomorrow to continue your ${studyData.streak}-day streak!`;
            streakMessage.style.color = 'white';
        }
        
        if (lastStudyDate) {
            lastStudyDate.textContent = studyData.lastStudyDate;
        }
    } else {
        streakBtn.disabled = false;
        streakBtn.innerHTML = '<span>üî• Mark Study Today</span>';
        streakBtn.style.background = '';
        streakBtn.style.opacity = '1';
        
        if (streakMessage) {
            if (studyData.streak > 0) {
                streakMessage.textContent = `Current streak: ${studyData.streak} days. Keep it going!`;
            } else {
                streakMessage.textContent = `Start a new study streak today!`;
            }
            streakMessage.style.color = 'white';
        }
        
        if (lastStudyDate) {
            if (studyData.lastStudyDate) {
                lastStudyDate.textContent = studyData.lastStudyDate;
            } else {
                lastStudyDate.textContent = 'Never';
            }
        }
    }
}

// ========== STUDY DATA MANAGEMENT ==========
function loadStudyData() {
    updateUI();
    updateStreakUI();
}

async function saveStudyDataToFirebase() {
    if (!currentUserId || !currentUser) return;
    
    const studentData = {
        name: currentUserName,
        userId: currentUserId,  // Our custom student ID
        firebaseUid: currentUser.uid,  // Firebase's anonymous UID
        streak: studyData.streak || 0,
        totalMinutes: studyData.totalMinutes || 0,
        totalStudyHours: (studyData.totalMinutes / 60).toFixed(1),
        points: Math.floor(studyData.totalMinutes / 60) * 100 || 0,
        lastActive: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        isStudentEntry: true,
        isTeacherAccount: false,
        isSameBrowserIssue: false  // Flag to identify
    };
    
    console.log(`üíæ Saving student data. Student ID: ${currentUserId}, Firebase UID: ${currentUser.uid}`);
    
    for (const classInfo of userClasses) {
        try {
            // Use our custom student ID as the key, not Firebase UID
            await firebaseSet(`classes/${classInfo.code}/students/${currentUserId}`, studentData);
            console.log(`‚úÖ Updated data in class: ${classInfo.code} with student ID: ${currentUserId}`);
            
        } catch (error) {
            console.error(`Error updating class ${classInfo.code}:`, error);
            
            try {
                await firebaseSet(`classStudents/${classInfo.code}/${currentUserId}`, studentData);
                console.log(`‚úÖ Updated data in classStudents: ${classInfo.code}`);
            } catch (altError) {
                console.error(`Both paths failed for ${classInfo.code}:`, altError);
            }
        }
    }
}

async function addStudyHours() {
    const input = document.getElementById('hoursInput');
    if (!input) {
        showNotification("Study hours input not found", "error");
        return;
    }
    
    const hours = parseFloat(input.value);
    
    if (!hours || hours <= 0) {
        showNotification("Please enter valid study hours (minimum 0.25)", "error");
        return;
    }
    
    const addButton = event.target;
    const originalText = addButton.innerHTML;
    
    addButton.innerHTML = '‚è≥ Saving...';
    addButton.disabled = true;
    
    const baseHours = hours;
    const streakBonus = studyData.streak > 7 ? 0.2 : studyData.streak > 3 ? 0.1 : 0;
    const bonusHours = baseHours * streakBonus;
    const totalHours = baseHours + bonusHours;
    
    studyData.totalMinutes += totalHours * 60;
    studyData.totalStudyHours = (studyData.totalMinutes / 60).toFixed(1);
    
    studyData.studySessions.push({
        date: new Date().toISOString(),
        hours: totalHours,
        baseHours: baseHours,
        bonusHours: bonusHours,
        streak: studyData.streak
    });
    
    persistData();
    updateUI();
    updateSidebarStats();
    input.value = "";
    
    updateSyncStatus("Syncing to all classes...", "syncing");
    await saveStudyDataToFirebase();
    
    setTimeout(() => {
        addButton.innerHTML = originalText;
        addButton.disabled = false;
    }, 1000);
    
    let message = `‚è∞ Added ${baseHours.toFixed(1)} study hours!`;
    if (bonusHours > 0) {
        message += ` (+${bonusHours.toFixed(1)} streak bonus)`;
    }
    message += ` Total: ${studyData.totalStudyHours} hours`;
    message += ` | Streak: ${studyData.streak} days üî•`;
    
    showNotification(message, "success");
    
    if (currentSection === 'statistics') {
        updateCharts();
    }
    
    setTimeout(() => {
        updateSyncStatus("Saved to all classes!", "success");
    }, 1500);
}

// ========== TASK MANAGEMENT WITH PRIORITIES ==========
function addTask() {
    let taskInput = document.getElementById('taskInput');
    if (!taskInput) taskInput = document.getElementById('taskInputFull');
    
    const text = taskInput.value.trim();
    
    if (!text) {
        showNotification("Please enter a task", "error");
        return;
    }
    
    const task = {
        id: Date.now().toString(),
        text: text,
        completed: false,
        createdAt: new Date().toISOString(),
        priority: selectedPriority,
        completedAt: null
    };
    
    tasks.unshift(task);
    taskInput.value = '';
    
    saveTasks();
    renderTasks();
    renderDashboardTasks();
    updateAllStatistics();
    
    const priorityText = {
        'urgent': 'üî¥ Urgent',
        'not-urgent': 'üü° Not Urgent',
        'optional': '‚ö™ Optional'
    }[selectedPriority];
    
    showNotification(`Task added as ${priorityText}!`, "success");
}

function selectPriority(priority) {
    selectedPriority = priority;
    
    document.querySelectorAll('.priority-option').forEach(option => {
        option.classList.remove('active');
        if (option.dataset.priority === priority) {
            option.classList.add('active');
        }
    });
}

function getPriorityClass(priority) {
    switch(priority) {
        case 'urgent': return 'urgent';
        case 'not-urgent': return 'not-urgent';
        case 'optional': return 'optional';
        default: return '';
    }
}

function getPriorityBadge(priority) {
    switch(priority) {
        case 'urgent': return '<span class="priority-badge priority-urgent">üî¥ Urgent</span>';
        case 'not-urgent': return '<span class="priority-badge priority-not-urgent">üü° Not Urgent</span>';
        case 'optional': return '<span class="priority-badge priority-optional">‚ö™ Optional</span>';
        default: return '';
    }
}

function toggleTask(taskId) {
    const task = tasks.find(t => t.id === taskId);
    if (task) {
        task.completed = !task.completed;
        task.completedAt = task.completed ? new Date().toISOString() : null;
        saveTasks();
        renderTasks();
        renderDashboardTasks();
        updateAllStatistics();
        
        if (task.completed) {
            showNotification("Task completed! ‚úÖ", "success");
        }
    }
}

function deleteTask(taskId) {
    tasks = tasks.filter(t => t.id !== taskId);
    saveTasks();
    renderTasks();
    renderDashboardTasks();
    updateAllStatistics();
    showNotification("Task deleted", "info");
}

function saveTasks() {
    persistData();
}

function renderTasks() {
    const fullTaskList = document.getElementById('fullTaskList');
    if (!fullTaskList) return;
    
    let filteredTasks = tasks;
    
    switch(currentTaskFilter) {
        case 'urgent':
            filteredTasks = tasks.filter(t => t.priority === 'urgent');
            break;
        case 'not-urgent':
            filteredTasks = tasks.filter(t => t.priority === 'not-urgent');
            break;
        case 'optional':
            filteredTasks = tasks.filter(t => t.priority === 'optional');
            break;
        case 'active':
            filteredTasks = tasks.filter(t => !t.completed);
            break;
        case 'completed':
            filteredTasks = tasks.filter(t => t.completed);
            break;
        case 'all':
        default:
            filteredTasks = tasks;
    }
    
    if (filteredTasks.length === 0) {
        fullTaskList.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üìù</div>
                <div class="empty-state-title">No tasks found</div>
                <div class="empty-state-description">
                    ${currentTaskFilter === 'all' ? 'Add your first task above!' : 
                      currentTaskFilter === 'active' ? 'All tasks are completed! üéâ' : 
                      currentTaskFilter === 'completed' ? 'No completed tasks yet' :
                      `No ${currentTaskFilter.replace('-', ' ')} tasks`}
                </div>
            </div>
        `;
    } else {
        fullTaskList.innerHTML = filteredTasks.map((task, index) => `
            <li class="task-item ${task.completed ? 'completed' : ''} ${getPriorityClass(task.priority)}">
                <div class="task-text" onclick="toggleTask('${task.id}')">
                    ${task.text}
                    <div style="margin-top: var(--spacing-xs);">
                        ${getPriorityBadge(task.priority)}
                    </div>
                </div>
                <div class="task-actions">
                    <button class="btn ${task.completed ? 'btn-success' : 'btn-warning'}" 
                            onclick="toggleTask('${task.id}')">
                        ${task.completed ? '‚úÖ Completed' : '‚¨ú Mark Done'}
                    </button>
                    <button class="btn btn-danger" onclick="deleteTask('${task.id}')">üóëÔ∏è Delete</button>
                </div>
            </li>
        `).join('');
    }
    
    updateTaskStats();
}

function renderDashboardTasks() {
    const taskList = document.getElementById('taskList');
    if (!taskList) return;
    
    const urgentTasks = tasks.filter(t => t.priority === 'urgent' && !t.completed);
    const notUrgentTasks = tasks.filter(t => t.priority === 'not-urgent' && !t.completed);
    const optionalTasks = tasks.filter(t => t.priority === 'optional' && !t.completed);
    
    const recentTasks = [...urgentTasks, ...notUrgentTasks, ...optionalTasks].slice(0, 5);
    
    if (recentTasks.length === 0) {
        taskList.innerHTML = `
            <div class="empty-state" style="padding: var(--spacing-lg);">
                <div class="empty-state-icon" style="font-size: 2rem;">üìù</div>
                <div class="empty-state-description">No tasks yet. Add your first task!</div>
            </div>
        `;
    } else {
        taskList.innerHTML = recentTasks.map(task => `
            <li class="task-item ${getPriorityClass(task.priority)}" style="padding: var(--spacing-md); margin-bottom: var(--spacing-sm);">
                <div class="task-text" onclick="toggleTask('${task.id}')" style="font-size: 1rem;">
                    ${task.text}
                    <div style="margin-top: var(--spacing-xs); font-size: 0.75rem;">
                        ${getPriorityBadge(task.priority)}
                    </div>
                </div>
                <div class="task-actions">
                    <button class="btn ${task.completed ? 'btn-success' : 'btn-secondary'}" 
                            onclick="toggleTask('${task.id}')" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                        ${task.completed ? '‚úÖ' : '‚¨ú'}
                    </button>
                </div>
            </li>
        `).join('');
    }
}

function filterTasks(filter) {
    currentTaskFilter = filter;
    renderTasks();
}

function updateTaskStats() {
    const totalTasks = tasks.length;
    const completedTasks = tasks.filter(t => t.completed).length;
    const pendingTasks = totalTasks - completedTasks;
    const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
    
    const totalTasksEl = document.getElementById('totalTasks');
    const pendingTasksEl = document.getElementById('pendingTasks');
    const completedTasksEl = document.getElementById('completedTasks');
    const completionRateEl = document.getElementById('completionRate');
    
    if (totalTasksEl) totalTasksEl.textContent = totalTasks;
    if (pendingTasksEl) pendingTasksEl.textContent = pendingTasks;
    if (completedTasksEl) completedTasksEl.textContent = completedTasks;
    if (completionRateEl) completionRateEl.textContent = `${completionRate}%`;
}

function clearCompletedTasks() {
    if (tasks.length === 0) {
        showNotification("No tasks to clear", "info");
        return;
    }
    
    const completedCount = tasks.filter(t => t.completed).length;
    if (completedCount === 0) {
        showNotification("No completed tasks to clear", "info");
        return;
    }
    
    if (confirm(`Clear ${completedCount} completed task${completedCount === 1 ? '' : 's'}?`)) {
        tasks = tasks.filter(t => !t.completed);
        saveTasks();
        renderTasks();
        renderDashboardTasks();
        updateAllStatistics();
        showNotification(`Cleared ${completedCount} completed task${completedCount === 1 ? '' : 's'}`, "success");
    }
}

// ========== ASSIGNMENT MANAGEMENT ==========
function loadAssignments() {
    renderAssignments();
    renderDashboardAssignments();
}

function addAssignment() {
    const name = document.getElementById('assignmentName').value.trim();
    const subject = document.getElementById('assignmentSubject').value.trim();
    const dueDate = document.getElementById('assignmentDueDate').value;
    const description = document.getElementById('assignmentDescription').value.trim();
    
    if (!name || !subject || !dueDate) {
        showNotification("Please fill all required fields", "error");
        return;
    }
    
    const assignment = {
        id: Date.now().toString(),
        name,
        subject,
        dueDate,
        description,
        createdAt: new Date().toISOString(),
        completed: false
    };
    
    assignments.unshift(assignment);
    saveAssignments();
    renderAssignments();
    renderDashboardAssignments();
    
    showNotification("Assignment added!", "success");
    hideAssignmentForm();
}

function renderAssignments() {
    const fullAssignmentList = document.getElementById('fullAssignmentList');
    if (!fullAssignmentList) return;
    
    if (assignments.length === 0) {
        fullAssignmentList.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üìö</div>
                <div class="empty-state-title">No assignments yet</div>
                <div class="empty-state-description">Add your first assignment!</div>
            </div>
        `;
    } else {
        fullAssignmentList.innerHTML = assignments.map((assignment, index) => {
            const dueDate = new Date(assignment.dueDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const diffTime = dueDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            let urgencyClass = 'normal';
            if (diffDays < 0) urgencyClass = 'overdue';
            else if (diffDays === 0) urgencyClass = 'today';
            else if (diffDays <= 3) urgencyClass = 'due-soon';
            
            return `
                <div class="assignment-item ${assignment.completed ? 'completed' : ''}">
                    <div class="assignment-header">
                        <div class="assignment-title">${assignment.name}</div>
                        <div class="assignment-date ${urgencyClass}">
                            ${urgencyClass === 'overdue' ? '‚ö†Ô∏è Overdue' : 
                              urgencyClass === 'today' ? 'üî• Due Today' : 
                              urgencyClass === 'due-soon' ? '‚è∞ Due Soon' : `üìÖ ${dueDate.toLocaleDateString()}`}
                        </div>
                    </div>
                    <div class="assignment-content">
                        <div style="color: var(--text-muted); margin-bottom: var(--spacing-sm);">
                            üìö ${assignment.subject}
                        </div>
                        ${assignment.description ? `<p>${assignment.description}</p>` : ''}
                    </div>
                    <div class="assignment-actions">
                        <button class="btn ${assignment.completed ? 'btn-success' : 'btn-secondary'}" onclick="toggleAssignment('${assignment.id}')">
                            ${assignment.completed ? '‚úÖ Completed' : '‚¨ú Mark Complete'}
                        </button>
                        <button class="btn btn-danger" onclick="deleteAssignment('${assignment.id}')">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `;
        }).join('');
    }
}

function renderDashboardAssignments() {
    const assignmentList = document.getElementById('assignmentList');
    if (!assignmentList) return;
    
    const recentAssignments = assignments.slice(0, 3);
    
    if (recentAssignments.length === 0) {
        assignmentList.innerHTML = `
            <div class="empty-state" style="padding: var(--spacing-lg);">
                <div class="empty-state-icon" style="font-size: 2rem;">üìö</div>
                <div class="empty-state-description">No assignments yet</div>
            </div>
        `;
    } else {
        assignmentList.innerHTML = recentAssignments.map(assignment => {
            const dueDate = new Date(assignment.dueDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const diffTime = dueDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            let urgencyClass = 'normal';
            if (diffDays < 0) urgencyClass = 'overdue';
            else if (diffDays === 0) urgencyClass = 'today';
            else if (diffDays <= 3) urgencyClass = 'due-soon';
            
            return `
                <div class="assignment-item" style="padding: var(--spacing-md); margin-bottom: var(--spacing-sm);">
                    <div class="assignment-header">
                        <div class="assignment-title" style="font-size: 1rem;">${assignment.name}</div>
                        <div class="assignment-date" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                            ${urgencyClass === 'overdue' ? '‚ö†Ô∏è' : 
                              urgencyClass === 'today' ? 'üî•' : 
                              urgencyClass === 'due-soon' ? '‚è∞' : 'üìÖ'}
                        </div>
                    </div>
                    <div style="color: var(--text-muted); font-size: 0.875rem;">
                        üìö ${assignment.subject}
                    </div>
                    <div style="margin-top: var(--spacing-sm);">
                        <button class="btn ${assignment.completed ? 'btn-success' : 'btn-secondary'}" 
                                onclick="toggleAssignment('${assignment.id}')" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                            ${assignment.completed ? '‚úÖ' : '‚¨ú'}
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }
}

function toggleAssignment(assignmentId) {
    const assignment = assignments.find(a => a.id === assignmentId);
    if (assignment) {
        assignment.completed = !assignment.completed;
        saveAssignments();
        renderAssignments();
        renderDashboardAssignments();
        showNotification(assignment.completed ? "Assignment marked as completed!" : "Assignment marked as incomplete", "success");
    }
}

function deleteAssignment(assignmentId) {
    assignments = assignments.filter(a => a.id !== assignmentId);
    saveAssignments();
    renderAssignments();
    renderDashboardAssignments();
    showNotification("Assignment deleted", "info");
}

function saveAssignments() {
    persistData();
}

function showAssignmentForm() {
    const form = document.getElementById('assignmentForm');
    if (form) form.style.display = 'block';
}

function hideAssignmentForm() {
    const form = document.getElementById('assignmentForm');
    if (form) form.style.display = 'none';
}

// ========== STATISTICS SECTION - ENHANCED ==========
function markStudySession() {
    const today = new Date().toDateString();
    
    const todaySession = studyData.dailyStats.find(s => s.date === today);
    if (todaySession) {
        showNotification("You've already marked a study session today! üéâ", "info");
        return;
    }
    
    const sessionHours = parseFloat(prompt("How many hours did you study today? (e.g., 2.5)", "1"));
    
    if (isNaN(sessionHours) || sessionHours <= 0) {
        showNotification("Please enter a valid number of hours", "error");
        return;
    }
    
    const focusScore = Math.min(100, Math.floor(Math.random() * 30) + 70);
    const consistencyScore = calculateConsistencyScore();
    
    studyData.dailyStats.unshift({
        date: today,
        sessions: 1,
        hours: sessionHours,
        focusScore: focusScore,
        consistencyScore: consistencyScore
    });
    
    studyData.focusScores.unshift({
        date: today,
        score: focusScore
    });
    
    studyData.consistencyScores.unshift({
        date: today,
        score: consistencyScore
    });
    
    if (studyData.dailyStats.length > 30) {
        studyData.dailyStats = studyData.dailyStats.slice(0, 30);
    }
    if (studyData.focusScores.length > 30) {
        studyData.focusScores = studyData.focusScores.slice(0, 30);
    }
    if (studyData.consistencyScores.length > 30) {
        studyData.consistencyScores = studyData.consistencyScores.slice(0, 30);
    }
    
    studyData.totalMinutes += sessionHours * 60;
    studyData.totalStudyHours = (studyData.totalMinutes / 60).toFixed(1);
    
    persistData();
    updateCharts();
    updateAllStatistics();
    updateDailyStatsOverview();
    
    showNotification(`Study session recorded! ${sessionHours} hours studied today.`, "success");
}

function calculateConsistencyScore() {
    if (studyData.dailyStats.length === 0) return 100;
    
    const last7Days = studyData.dailyStats.slice(0, 7);
    const daysStudied = last7Days.length;
    const totalDays = Math.min(7, studyData.dailyStats.length);
    
    return Math.min(100, Math.floor((daysStudied / totalDays) * 100));
}

function updateDailyStatsOverview() {
    const today = new Date().toDateString();
    const todayStats = studyData.dailyStats.find(s => s.date === today);
    
    document.getElementById('todayFocusScore').textContent = todayStats ? `${todayStats.focusScore}%` : '0%';
    document.getElementById('todaySessions').textContent = todayStats ? todayStats.sessions : '0';
    document.getElementById('todayConsistency').textContent = todayStats ? `${todayStats.consistencyScore}%` : '0%';
    
    updateTrends();
}

function updateTrends() {
    if (studyData.dailyStats.length < 2) return;
    
    const today = studyData.dailyStats[0];
    const yesterday = studyData.dailyStats[1];
    
    updateTrend('focus', today ? today.focusScore : 0, yesterday ? yesterday.focusScore : 0, 'focusTrend');
    updateTrend('sessions', today ? today.sessions : 0, yesterday ? yesterday.sessions : 0, 'sessionsTrend');
    updateTrend('consistency', today ? today.consistencyScore : 0, yesterday ? yesterday.consistencyScore : 0, 'consistencyTrend');
}

function updateTrend(type, todayValue, yesterdayValue, elementId) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const diff = todayValue - yesterdayValue;
    let trendIcon = '‚û°Ô∏è';
    let trendText = 'No change';
    let trendClass = 'trend-neutral';
    
    if (diff > 0) {
        trendIcon = 'üìà';
        trendText = `+${diff} from yesterday`;
        trendClass = 'trend-up';
    } else if (diff < 0) {
        trendIcon = 'üìâ';
        trendText = `${diff} from yesterday`;
        trendClass = 'trend-down';
    }
    
    element.innerHTML = `<span>${trendIcon}</span><span>${trendText}</span>`;
    element.className = `daily-stat-trend ${trendClass}`;
}

function updateCharts() {
    if (focusChart) focusChart.destroy();
    if (sessionsChart) sessionsChart.destroy();
    if (consistencyChart) consistencyChart.destroy();
    if (hoursChart) hoursChart.destroy();
    if (tasksChart) tasksChart.destroy();
    if (weeklyChart) weeklyChart.destroy();
    if (assignmentsChart) assignmentsChart.destroy();
    if (streakChart) streakChart.destroy();
    
    updateStatisticsSummary();
    updateDailyStatsOverview();
    
    createDailyStatsCharts();
    createHoursChart();
    createTasksChart();
    createWeeklyChart();
    createAssignmentsChart();
    createStreakChart();
}

function createDailyStatsCharts() {
    const last7Days = Array.from({length: 7}, (_, i) => {
        const date = new Date();
        date.setDate(date.getDate() - i);
        return date.toDateString();
    }).reverse();
    
    const focusData = last7Days.map(day => {
        const stat = studyData.dailyStats.find(s => s.date === day);
        return stat ? stat.focusScore : 0;
    });
    
    const sessionsData = last7Days.map(day => {
        const stat = studyData.dailyStats.find(s => s.date === day);
        return stat ? stat.sessions : 0;
    });
    
    const consistencyData = last7Days.map(day => {
        const stat = studyData.dailyStats.find(s => s.date === day);
        return stat ? stat.consistencyScore : 0;
    });
    
    const formattedDates = last7Days.map(date => {
        const d = new Date(date);
        return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    });
    
    const focusCtx = document.getElementById('focusChart').getContext('2d');
    focusChart = new Chart(focusCtx, {
        type: 'bar',
        data: {
            labels: formattedDates,
            datasets: [{
                label: 'Focus Score (%)',
                data: focusData,
                backgroundColor: 'rgba(79, 70, 229, 0.7)',
                borderColor: 'rgba(79, 70, 229, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Score (%)'
                    }
                }
            }
        }
    });
    
    const sessionsCtx = document.getElementById('sessionsChart').getContext('2d');
    sessionsChart = new Chart(sessionsCtx, {
        type: 'bar',
        data: {
            labels: formattedDates,
            datasets: [{
                label: 'Study Sessions',
                data: sessionsData,
                backgroundColor: 'rgba(16, 185, 129, 0.7)',
                borderColor: 'rgba(16, 185, 129, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Sessions'
                    }
                }
            }
        }
    });
    
    const consistencyCtx = document.getElementById('consistencyChart').getContext('2d');
    consistencyChart = new Chart(consistencyCtx, {
        type: 'bar',
        data: {
            labels: formattedDates,
            datasets: [{
                label: 'Consistency Score (%)',
                data: consistencyData,
                backgroundColor: 'rgba(245, 158, 11, 0.7)',
                borderColor: 'rgba(245, 158, 11, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Score (%)'
                    }
                }
            }
        }
    });
}

function createHoursChart() {
    const ctx = document.getElementById('hoursChart').getContext('2d');
    
    const last7Days = Array.from({length: 7}, (_, i) => {
        const date = new Date();
        date.setDate(date.getDate() - i);
        return date.toDateString();
    }).reverse();
    
    const dailyHours = last7Days.map(day => {
        const daySessions = studyData.studySessions.filter(s => {
            const sessionDate = new Date(s.date).toDateString();
            return sessionDate === day;
        });
        return daySessions.reduce((sum, session) => sum + session.hours, 0);
    });
    
    hoursChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: last7Days.map(date => new Date(date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })),
            datasets: [{
                label: 'Study Hours',
                data: dailyHours,
                backgroundColor: 'rgba(79, 70, 229, 0.7)',
                borderColor: 'rgba(79, 70, 229, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Hours'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Date'
                    }
                }
            }
        }
    });
}

function createTasksChart() {
    const ctx = document.getElementById('tasksChart').getContext('2d');
    const completedTasks = tasks.filter(t => t.completed).length;
    const pendingTasks = tasks.filter(t => !t.completed).length;
    
    tasksChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Completed', 'Pending'],
            datasets: [{
                data: [completedTasks, pendingTasks],
                backgroundColor: [
                    'rgba(16, 185, 129, 0.7)',
                    'rgba(245, 158, 11, 0.7)'
                ],
                borderColor: [
                    'rgba(16, 185, 129, 1)',
                    'rgba(245, 158, 11, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function createWeeklyChart() {
    const ctx = document.getElementById('weeklyChart').getContext('2d');
    const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    
    weeklyChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: daysOfWeek,
            datasets: [{
                label: 'Study Hours',
                data: studyData.weeklyPattern,
                backgroundColor: 'rgba(139, 92, 246, 0.2)',
                borderColor: 'rgba(139, 92, 246, 1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Study Sessions'
                    }
                }
            }
        }
    });
}

function createAssignmentsChart() {
    const ctx = document.getElementById('assignmentsChart').getContext('2d');
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const overdue = assignments.filter(a => {
        const dueDate = new Date(a.dueDate);
        return dueDate < today && !a.completed;
    }).length;
    
    const dueToday = assignments.filter(a => {
        const dueDate = new Date(a.dueDate);
        dueDate.setHours(0, 0, 0, 0);
        return dueDate.getTime() === today.getTime() && !a.completed;
    }).length;
    
    const dueSoon = assignments.filter(a => {
        const dueDate = new Date(a.dueDate);
        const diffTime = dueDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays > 0 && diffDays <= 3 && !a.completed;
    }).length;
    
    const completed = assignments.filter(a => a.completed).length;
    const future = assignments.filter(a => {
        const dueDate = new Date(a.dueDate);
        const diffTime = dueDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays > 3 && !a.completed;
    }).length;
    
    assignmentsChart = new Chart(ctx, {
        type: 'polarArea',
        data: {
            labels: ['Overdue', 'Due Today', 'Due Soon', 'Completed', 'Future'],
            datasets: [{
                data: [overdue, dueToday, dueSoon, completed, future],
                backgroundColor: [
                    'rgba(239, 68, 68, 0.7)',
                    'rgba(245, 158, 11, 0.7)',
                    'rgba(59, 130, 246, 0.7)',
                    'rgba(16, 185, 129, 0.7)',
                    'rgba(156, 163, 175, 0.7)'
                ],
                borderColor: [
                    'rgba(239, 68, 68, 1)',
                    'rgba(245, 158, 11, 1)',
                    'rgba(59, 130, 246, 1)',
                    'rgba(16, 185, 129, 1)',
                    'rgba(156, 163, 175, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

function createStreakChart() {
    const ctx = document.getElementById('streakChart').getContext('2d');
    
    const last14Days = Array.from({length: 14}, (_, i) => {
        const date = new Date();
        date.setDate(date.getDate() - i);
        return date.toDateString();
    }).reverse();
    
    const streakData = last14Days.map(day => {
        const streakEntry = studyData.streakHistory.find(s => s.date === day);
        return streakEntry ? streakEntry.streak : 0;
    });
    
    streakChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: last14Days.map(date => new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
            datasets: [{
                label: 'Streak',
                data: streakData,
                backgroundColor: 'rgba(245, 158, 11, 0.2)',
                borderColor: 'rgba(245, 158, 11, 1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Streak Days'
                    }
                }
            }
        }
    });
}

function refreshCharts() {
    updateCharts();
    showNotification("Charts refreshed!", "success");
}

function updateStatisticsSummary() {
    document.getElementById('statsTotalHours').textContent = parseFloat(studyData.totalStudyHours || (studyData.totalMinutes / 60).toFixed(1)).toFixed(1);
    document.getElementById('statsStreak').textContent = studyData.streak || 0;
    
    const totalTasks = tasks.length;
    const completedTasks = tasks.filter(t => t.completed).length;
    const taskRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
    document.getElementById('statsTaskRate').textContent = `${taskRate}%`;
    
    const focusScore = calculateFocusScore();
    document.getElementById('statsFocusScore').textContent = `${focusScore}%`;
    
    const hoursDetails = document.getElementById('statsHoursDetails');
    const streakDetails = document.getElementById('statsStreakDetails');
    const taskDetails = document.getElementById('statsTaskDetails');
    const focusDetails = document.getElementById('statsFocusDetails');
    
    if (hoursDetails) {
        const avgDaily = studyData.totalStudyDays > 0 ? (parseFloat(studyData.totalStudyHours) / studyData.totalStudyDays).toFixed(1) : 0;
        hoursDetails.textContent = `${studyData.studySessions.length} sessions | Avg: ${avgDaily}h/day`;
    }
    
    if (streakDetails) {
        const longestStreak = Math.max(...(studyData.streakHistory.map(s => s.streak)), 0);
        streakDetails.textContent = `Longest: ${longestStreak} days`;
    }
    
    if (taskDetails) {
        taskDetails.textContent = `${completedTasks}/${totalTasks} completed`;
    }
    
    if (focusDetails) {
        focusDetails.textContent = `Based on consistency & completion`;
    }
    
    updateDetailedMetrics();
}

function updateDetailedMetrics() {
    const totalSessions = studyData.studySessions.length;
    const avgDailyHours = studyData.totalStudyDays > 0 ? (parseFloat(studyData.totalStudyHours) / studyData.totalStudyDays).toFixed(1) : 0;
    const longestSession = studyData.studySessions.length > 0 ? 
        Math.max(...studyData.studySessions.map(s => s.hours)).toFixed(1) : 0;
    
    const completedTasks = tasks.filter(t => t.completed).length;
    const activeTasks = tasks.filter(t => !t.completed).length;
    const avgTasksPerDay = studyData.totalStudyDays > 0 ? (tasks.length / studyData.totalStudyDays).toFixed(1) : 0;
    
    const totalPoints = Math.floor(parseFloat(studyData.totalStudyHours) * 100);
    const longestStreak = Math.max(...(studyData.streakHistory.map(s => s.streak)), 0);
    const consistencyScore = studyData.totalStudyDays > 0 ? 
        Math.round((studyData.streak / studyData.totalStudyDays) * 100) : 0;
    
    document.getElementById('avgDailyHours').textContent = avgDailyHours;
    document.getElementById('totalSessions').textContent = totalSessions;
    document.getElementById('longestSession').textContent = `${longestSession}h`;
    document.getElementById('avgTasksPerDay').textContent = avgTasksPerDay;
    document.getElementById('activeTasksCount').textContent = activeTasks;
    document.getElementById('totalPoints').textContent = totalPoints;
    document.getElementById('longestStreak').textContent = longestStreak;
    document.getElementById('consistencyScore').textContent = `${consistencyScore}%`;
    
    const completedTasksWithTime = tasks.filter(t => t.completed && t.createdAt && t.completedAt);
    let fastestCompletion = 'N/A';
    if (completedTasksWithTime.length > 0) {
        const fastest = completedTasksWithTime.reduce((fastest, task) => {
            const created = new Date(task.createdAt);
            const completed = new Date(task.completedAt);
            const hours = (completed - created) / (1000 * 60 * 60);
            return hours < fastest ? hours : fastest;
        }, Infinity);
        fastestCompletion = fastest !== Infinity ? `${fastest.toFixed(1)}h` : 'N/A';
    }
    document.getElementById('fastestCompletion').textContent = fastestCompletion;
}

function exportStatistics() {
    const statsData = {
        exportDate: new Date().toISOString(),
        summary: {
            totalHours: parseFloat(studyData.totalStudyHours || (studyData.totalMinutes / 60).toFixed(1)),
            currentStreak: studyData.streak || 0,
            taskCompletionRate: tasks.length > 0 ? Math.round((tasks.filter(t => t.completed).length / tasks.length) * 100) : 0,
            focusScore: calculateFocusScore()
        },
        detailed: {
            totalSessions: studyData.studySessions.length,
            avgDailyHours: studyData.totalStudyDays > 0 ? (parseFloat(studyData.totalStudyHours) / studyData.totalStudyDays).toFixed(1) : 0,
            totalTasks: tasks.length,
            completedTasks: tasks.filter(t => t.completed).length,
            totalAssignments: assignments.length,
            completedAssignments: assignments.filter(a => a.completed).length,
            weeklyPattern: studyData.weeklyPattern,
            streakHistory: studyData.streakHistory,
            dailyStats: studyData.dailyStats
        }
    };
    
    const dataStr = JSON.stringify(statsData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    const exportFileDefaultName = `student-stats-${new Date().toISOString().split('T')[0]}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    showNotification("Statistics exported successfully!", "success");
}

// ========== INSPIRING STORIES ==========
function loadInspiringStories() {
    const storiesList = document.getElementById('storiesList');
    if (!storiesList) return;
    
    const shuffledStories = [...inspiringStories].sort(() => 0.5 - Math.random()).slice(0, 3);
    
    storiesList.innerHTML = shuffledStories.map(story => `
        <div class="story-item" onclick="showStoryModal(${story.id})">
            <div class="story-name">
                ${story.icon} ${story.name}
            </div>
            <div class="story-quote">"${story.quote}"</div>
        </div>
    `).join('');
}

function showStoryModal(storyId) {
    const story = inspiringStories.find(s => s.id === storyId);
    if (!story) return;
    
    const modal = document.getElementById('storyModal');
    const title = document.getElementById('storyModalTitle');
    const content = document.getElementById('storyModalContent');
    
    title.textContent = `${story.icon} ${story.name}'s Story`;
    
    content.innerHTML = `
        <div style="margin-bottom: var(--spacing-lg);">
            <h3 style="color: var(--accent); margin-bottom: var(--spacing-sm);">Their Famous Quote:</h3>
            <div style="font-style: italic; font-size: 1.25rem; color: var(--text); padding: var(--spacing-md); background: var(--bg); border-radius: var(--radius); border-left: 4px solid var(--accent);">
                "${story.quote}"
            </div>
        </div>
        
        <div style="margin-bottom: var(--spacing-lg);">
            <h3 style="color: var(--accent); margin-bottom: var(--spacing-sm);">Their Journey:</h3>
            <p style="line-height: 1.6;">${story.story}</p>
        </div>
        
        <div style="margin-bottom: var(--spacing-lg);">
            <h3 style="color: var(--accent); margin-bottom: var(--spacing-sm);">Challenges They Overcame:</h3>
            <ul style="padding-left: var(--spacing-lg); line-height: 1.6;">
                ${story.struggles.map(s => `<li style="margin-bottom: var(--spacing-xs);">${s}</li>`).join('')}
            </ul>
        </div>
        
        <div style="padding: var(--spacing-lg); background: var(--accent-light); border-radius: var(--radius); border-left: 4px solid var(--accent);">
            <h3 style="color: var(--accent); margin-bottom: var(--spacing-sm);">üí° Key Lesson:</h3>
            <p style="font-weight: 600; color: var(--text);">${story.lessons}</p>
        </div>
    `;
    
    modal.style.display = 'flex';
}

function closeStoryModal() {
    document.getElementById('storyModal').style.display = 'none';
}

// ========== CLASS MANAGEMENT ==========
function updateClassSelector() {
    const selector = document.getElementById('classSelector');
    if (!selector) return;
    
    selector.innerHTML = '<option value="">Select a Class</option>';
    
    userClasses.forEach((classInfo, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = `${classInfo.name || 'Class'} (${classInfo.code})`;
        if (index === selectedClassIndex) {
            option.selected = true;
        }
        selector.appendChild(option);
    });
}

async function switchClass(classIndex) {
    if (classIndex === "") return;
    
    classIndex = parseInt(classIndex);
    if (classIndex >= 0 && classIndex < userClasses.length) {
        selectedClassIndex = classIndex;
        currentClassCode = userClasses[classIndex].code;
        
        console.log(`üîÑ Switched to class: ${currentClassCode}`);
        
        persistData();
        loadClassroomData();
        if (currentSection === 'classroom') {
            await loadTeacherContent();
            await loadClassLeaderboard();
        }
        
        showNotification(`Switched to ${userClasses[classIndex].name || 'Class'}`, "success");
    }
}

function showJoinClassForm() {
    const form = document.getElementById('joinClassForm');
    if (form) {
        form.style.display = 'block';
        document.getElementById('joinClassCode').focus();
    }
}

function hideJoinClassForm() {
    const form = document.getElementById('joinClassForm');
    if (form) form.style.display = 'none';
}

async function joinClass() {
    const classCodeInput = document.getElementById('joinClassCode');
    const classCode = classCodeInput.value.toUpperCase().trim();
    
    if (!classCode || classCode.length !== 6) {
        showNotification("Please enter a valid 6-digit class code", "error");
        return;
    }
    
    const joinBtn = event.target;
    const originalText = joinBtn.innerHTML;
    joinBtn.innerHTML = 'üîÑ Joining...';
    joinBtn.disabled = true;
    
    try {
        console.log(`üéì Attempting to join class: ${classCode}`);
        
        if (userClasses.some(c => c.code === classCode)) {
            showNotification("You've already joined this class", "info");
            hideJoinClassForm();
            joinBtn.innerHTML = originalText;
            joinBtn.disabled = false;
            return;
        }
        
        // Check if class exists by trying multiple paths
        let classData = null;
        try {
            classData = await firebaseGet('classCodes/' + classCode);
        } catch (error) {
            console.log("Trying alternative path...");
            classData = await firebaseGet('classes/' + classCode);
        }
        
        if (!classData) {
            showNotification("Class not found. Check the code and try again.", "error");
            joinBtn.innerHTML = originalText;
            joinBtn.disabled = false;
            return;
        }
        
        console.log("‚úÖ Class found:", classData);
        
        const studentData = {
            name: currentUserName || 'Student',
            userId: currentUserId,
            firebaseUid: currentUser ? currentUser.uid : null,
            streak: studyData.streak || 0,
            totalMinutes: studyData.totalMinutes || 0,
            totalStudyHours: (studyData.totalMinutes / 60).toFixed(1),
            points: Math.floor(studyData.totalMinutes / 60) * 100 || 0,
            lastActive: new Date().toISOString(),
            joinedAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            isStudentEntry: true,
            isTeacherAccount: false
        };
        
        console.log(`üì§ Writing student data to class ${classCode}...`);
        
        // TRY MULTIPLE PATHS
        let success = false;
        let errorMessages = [];
        
        // Path 1: classes/classCode/students
        try {
            await firebaseSet(`classes/${classCode}/students/${currentUserId}`, studentData);
            console.log(`‚úÖ Path 1 successful: classes/${classCode}/students/${currentUserId}`);
            success = true;
        } catch (error1) {
            errorMessages.push(`Path 1: ${error1.message}`);
            console.error(`‚ùå Path 1 failed: ${error1.message}`);
        }
        
        // Path 2: classStudents/classCode
        if (!success) {
            try {
                await firebaseSet(`classStudents/${classCode}/${currentUserId}`, studentData);
                console.log(`‚úÖ Path 2 successful: classStudents/${classCode}/${currentUserId}`);
                success = true;
            } catch (error2) {
                errorMessages.push(`Path 2: ${error2.message}`);
                console.error(`‚ùå Path 2 failed: ${error2.message}`);
            }
        }
        
        // Path 3: Alternative path for permission issues
        if (!success) {
            try {
                // Try with a simpler path that might have fewer restrictions
                const simpleData = {
                    name: currentUserName || 'Student',
                    streak: studyData.streak || 0,
                    totalHours: (studyData.totalMinutes / 60).toFixed(1),
                    joined: new Date().toISOString()
                };
                
                await firebaseSet(`studentList/${classCode}/${currentUserId}`, simpleData);
                console.log(`‚úÖ Path 3 successful: studentList/${classCode}/${currentUserId}`);
                success = true;
            } catch (error3) {
                errorMessages.push(`Path 3: ${error3.message}`);
                console.error(`‚ùå Path 3 failed: ${error3.message}`);
            }
        }
        
        if (!success) {
            console.error("All paths failed:", errorMessages);
            showNotification("Could not join class due to permissions. Try using incognito mode.", "error");
            
            // Show detailed error
            console.log("Full error details:", {
                classCode,
                teacherId: classData.teacherId,
                currentUserId,
                currentUserUid: currentUser?.uid,
                errorMessages
            });
            
            joinBtn.innerHTML = originalText;
            joinBtn.disabled = false;
            return;
        }
        
        // If we get here, student was successfully added
        const newClass = {
            code: classCode,
            name: classData.name || 'Class ' + classCode,
            teacherId: classData.teacherId,
            joinedAt: new Date().toISOString()
        };
        
        userClasses.push(newClass);
        currentClassCode = classCode;
        selectedClassIndex = userClasses.length - 1;
        
        saveUserData();
        persistData();
        
        updateClassSelector();
        renderClassesList();
        loadClassroomData();
        
        classCodeInput.value = '';
        hideJoinClassForm();
        
        // Force save study data to ensure it appears in teacher's view
        await saveStudyDataToFirebase();
        
        showNotification(`Successfully joined ${classData.name || 'the class'}!`, "success");
        
        if (currentSection === 'classroom') {
            await loadTeacherContent();
            await loadClassLeaderboard();
        }
        
    } catch (error) {
        console.error("‚ùå Join class error:", error);
        console.error("Error stack:", error.stack);
        
        showNotification("Failed to join class: " + (error.message || "Unknown error"), "error");
    } finally {
        joinBtn.innerHTML = originalText;
        joinBtn.disabled = false;
    }
}

function renderClassesList() {
    const classesList = document.getElementById('classesList');
    const noClassesMessage = document.getElementById('noClassesMessage');
    
    if (!classesList) return;
    
    if (userClasses.length === 0) {
        classesList.innerHTML = '';
        if (noClassesMessage) noClassesMessage.style.display = 'block';
        return;
    }
    
    if (noClassesMessage) noClassesMessage.style.display = 'none';
    
    classesList.innerHTML = userClasses.map((classInfo, index) => {
        const isActive = index === selectedClassIndex;
        
        return `
            <div class="class-card ${isActive ? 'active' : ''}">
                <div class="class-card-header">
                    <div class="class-card-title">${classInfo.name || 'Class'}</div>
                    <div class="class-card-code">${classInfo.code}</div>
                </div>
                <div style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: var(--spacing-sm);">
                    Joined: ${new Date(classInfo.joinedAt).toLocaleDateString()}
                </div>
                <div class="class-card-stats">
                    <div class="class-card-stat">
                        <div class="value">${studyData.streak || 0}</div>
                        <div class="label">Streak</div>
                    </div>
                    <div class="class-card-stat">
                        <div class="value">${(studyData.totalMinutes / 60).toFixed(1)}</div>
                        <div class="label">Hours</div>
                    </div>
                </div>
                <div class="class-card-actions">
                    <button class="btn ${isActive ? 'btn-primary' : 'btn-secondary'}" 
                            onclick="switchClass(${index})" style="flex: 1;">
                        ${isActive ? '‚úì Active' : 'Switch'}
                    </button>
                    <button class="btn btn-danger" onclick="leaveClassConfirm('${classInfo.code}')">
                        üö™ Leave
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

function leaveClassConfirm(classCode) {
    if (confirm(`Are you sure you want to leave this class?`)) {
        leaveClass(classCode);
    }
}

async function leaveClass(classCodeToLeave = null) {
    const classCode = classCodeToLeave || currentClassCode;
    
    if (!classCode) {
        showNotification("No class to leave", "error");
        return;
    }
    
    const classIndex = userClasses.findIndex(c => c.code === classCode);
    if (classIndex === -1) {
        showNotification("Class not found in your list", "error");
        return;
    }
    
    const className = userClasses[classIndex].name || 'Class';
    
    try {
        await firebaseRemove(`classes/${classCode}/students/${currentUserId}`);
        console.log(`‚úÖ Student removed from class: ${classCode}`);
    } catch (error) {
        console.error("Error removing student from Firebase:", error);
    }
    
    userClasses.splice(classIndex, 1);
    
    if (classCode === currentClassCode) {
        if (userClasses.length > 0) {
            selectedClassIndex = 0;
            currentClassCode = userClasses[0].code;
        } else {
            currentClassCode = null;
            selectedClassIndex = -1;
        }
    }
    
    saveUserData();
    persistData();
    
    updateClassSelector();
    renderClassesList();
    loadClassroomData();
    
    if (currentSection === 'classroom') {
        await loadTeacherContent();
        await loadClassLeaderboard();
    }
    
    showNotification(`You have left ${className}`, "success");
}

// ========== CLASSROOM MANAGEMENT ==========
function loadClassroomData() {
    const notInClassView = document.getElementById('notInClassView');
    const inClassView = document.getElementById('inClassView');
    
    if (currentClassCode && userClasses.length > 0) {
        notInClassView.style.display = 'none';
        inClassView.style.display = 'block';
        
        const codeElement = document.getElementById('currentClassCode');
        if (codeElement) codeElement.textContent = currentClassCode;
        
        loadTeacherContent();
        loadClassLeaderboard();
    } else {
        if (notInClassView) notInClassView.style.display = 'block';
        if (inClassView) inClassView.style.display = 'none';
    }
}

async function loadTeacherContent() {
    if (!currentClassCode) {
        console.log("‚ùå Cannot load teacher content: No class selected");
        return;
    }
    
    console.log(`üì¢ Loading teacher content for class: ${currentClassCode}`);
    
    try {
        const announcements = await firebaseGet(`announcements/${currentClassCode}`);
        const announcementsDiv = document.getElementById('teacherAnnouncements');
        
        if (announcements && announcementsDiv) {
            const announcementList = Object.entries(announcements).map(([id, ann]) => ({
                id,
                ...ann
            }));
            
            announcementList.sort((a, b) => {
                const dateA = new Date(a.createdAt || a.date || 0);
                const dateB = new Date(b.createdAt || b.date || 0);
                return dateB - dateA;
            });
            
            if (announcementList.length === 0) {
                announcementsDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¢</div>
                        <div class="empty-state-title">No announcements yet</div>
                        <div class="empty-state-description">Check back later for updates from your teacher</div>
                    </div>
                `;
            } else {
                announcementsDiv.innerHTML = announcementList.map((ann, index) => `
                    <div class="classroom-item">
                        <div class="classroom-item-header">
                            <div class="classroom-item-title">${ann.title || 'Announcement'}</div>
                            <div class="classroom-item-date">
                                üìÖ ${new Date(ann.createdAt || ann.date || Date.now()).toLocaleDateString()}
                            </div>
                        </div>
                        <div class="classroom-item-content">
                            <p>${ann.content || ''}</p>
                        </div>
                    </div>
                `).join('');
            }
            
            const countElement = document.getElementById('announcementCount');
            if (countElement) countElement.textContent = announcementList.length;
        } else {
            if (announcementsDiv) {
                announcementsDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¢</div>
                        <div class="empty-state-title">No announcements yet</div>
                        <div class="empty-state-description">Check back later for updates from your teacher</div>
                    </div>
                `;
                const countElement = document.getElementById('announcementCount');
                if (countElement) countElement.textContent = '0';
            }
        }
    } catch (error) {
        console.error("‚ùå Error loading announcements:", error);
        const announcementsDiv = document.getElementById('teacherAnnouncements');
        if (announcementsDiv) {
            announcementsDiv.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">‚ùå</div>
                    <div class="empty-state-title">Error loading announcements</div>
                    <div class="empty-state-description">You may need to refresh or check your connection</div>
                </div>
            `;
        }
    }
    
    try {
        const resources = await firebaseGet(`resources/${currentClassCode}`);
        const resourcesDiv = document.getElementById('teacherResources');
        
        if (resources && resourcesDiv) {
            const resourceList = Object.entries(resources).map(([id, res]) => ({
                id,
                ...res
            }));
            
            if (resourceList.length === 0) {
                resourcesDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìö</div>
                        <div class="empty-state-title">No resources yet</div>
                        <div class="empty-state-description">Your teacher will add resources here</div>
                    </div>
                `;
            } else {
                resourcesDiv.innerHTML = resourceList.map((res, index) => `
                    <div class="classroom-item">
                        <div class="classroom-item-header">
                            <div class="classroom-item-title">${res.title || 'Resource'}</div>
                            <div class="classroom-item-date">
                                üìÖ ${new Date(res.createdAt || res.date || Date.now()).toLocaleDateString()}
                            </div>
                        </div>
                        <div class="classroom-item-content">
                            ${res.description ? `<p>${res.description}</p>` : ''}
                            ${res.url ? `
                                <a href="${res.url}" target="_blank" class="classroom-item-link">
                                    üìé ${res.url}
                                </a>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            }
            
            const countElement = document.getElementById('resourceCount');
            if (countElement) countElement.textContent = resourceList.length;
        } else {
            if (resourcesDiv) {
                resourcesDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìö</div>
                        <div class="empty-state-title">No resources yet</div>
                        <div class="empty-state-description">Your teacher will add resources here</div>
                    </div>
                `;
                const countElement = document.getElementById('resourceCount');
                if (countElement) countElement.textContent = '0';
            }
        }
    } catch (error) {
        console.error("‚ùå Error loading resources:", error);
        const resourcesDiv = document.getElementById('teacherResources');
        if (resourcesDiv) {
            resourcesDiv.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">‚ùå</div>
                    <div class="empty-state-title">Error loading resources</div>
                    <div class="empty-state-description">You may need to refresh or check your connection</div>
                </div>
            `;
        }
    }
}

async function loadClassLeaderboard() {
    if (!currentClassCode) {
        console.log("‚ùå Cannot load leaderboard: No class selected");
        showLeaderboardError("Not connected to a class");
        return;
    }
    
    console.log(`üìä Loading leaderboard for class: ${currentClassCode}`);
    
    const leaderboardDiv = document.getElementById('classLeaderboard');
    if (leaderboardDiv) {
        leaderboardDiv.innerHTML = `
            <div class="loading">
                <div>Loading leaderboard...</div>
            </div>
        `;
    }
    
    try {
        const students = await firebaseGet(`classes/${currentClassCode}/students`);
        
        if (!students) {
            showLeaderboardEmpty();
            return;
        }
        
        const studentList = Object.entries(students).map(([id, studentData]) => {
            const totalStudyHours = studentData.totalStudyHours || (studentData.totalMinutes / 60).toFixed(1) || 0;
            
            return {
                id,
                name: studentData.name || 'Student ' + id.substr(0, 6),
                totalStudyHours: parseFloat(totalStudyHours),
                streak: studentData.streak || 0,
                points: studentData.points || Math.floor(totalStudyHours * 100) || 0,
                lastActive: studentData.lastActive || 'Unknown',
                isTeacherAccount: id.includes('teacher') || studentData.name?.includes('Teacher')
            };
        });
        
        const filteredStudents = studentList.filter(s => !s.isTeacherAccount);
        filteredStudents.sort((a, b) => b.totalStudyHours - a.totalStudyHours);
        
        renderLeaderboard(filteredStudents);
        
    } catch (error) {
        console.error("‚ùå Error loading leaderboard:", error);
        showLeaderboardError("Failed to load leaderboard. Please try again.");
    }
}

function renderLeaderboard(students) {
    const leaderboardDiv = document.getElementById('classLeaderboard');
    if (!leaderboardDiv) return;
    
    if (students.length === 0) {
        showLeaderboardEmpty();
        return;
    }
    
    const totalStudents = students.length;
    const totalHours = students.reduce((sum, student) => sum + student.totalStudyHours, 0);
    const avgHours = totalStudents > 0 ? totalHours / totalStudents : 0;
    const topStudent = students.length > 0 ? students[0] : null;
    
    leaderboardDiv.innerHTML = `
        <div class="leaderboard-stats">
            <div class="leaderboard-stat">
                <div class="value">${totalStudents}</div>
                <div class="label">Students</div>
            </div>
            <div class="leaderboard-stat">
                <div class="value">${totalHours.toFixed(1)}</div>
                <div class="label">Total Hours</div>
            </div>
            <div class="leaderboard-stat">
                <div class="value">${avgHours.toFixed(1)}</div>
                <div class="label">Avg/Student</div>
            </div>
            <div class="leaderboard-stat">
                <div class="value">${topStudent ? topStudent.totalStudyHours.toFixed(1) : '0.0'}</div>
                <div class="label">Top Score</div>
            </div>
        </div>
        
        <div class="leaderboard-list">
            ${students.map((student, index) => {
                const isCurrentUser = student.id === currentUserId;
                const rankClass = `rank-${index + 1}`;
                const isTopThree = index < 3;
                
                const initials = student.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                
                let lastActiveText = 'Never';
                if (student.lastActive && student.lastActive !== 'Unknown') {
                    const lastActive = new Date(student.lastActive);
                    const now = new Date();
                    const diffDays = Math.floor((now - lastActive) / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 0) lastActiveText = 'Today';
                    else if (diffDays === 1) lastActiveText = 'Yesterday';
                    else if (diffDays < 7) lastActiveText = `${diffDays}d ago`;
                    else if (diffDays < 30) lastActiveText = `${Math.floor(diffDays/7)}w ago`;
                    else lastActiveText = lastActive.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }
                
                return `
                    <div class="leaderboard-item ${rankClass} ${isCurrentUser ? 'you' : ''}">
                        <div class="leaderboard-rank">
                            ${isTopThree ? ['ü•á', 'ü•à', 'ü•â'][index] : `#${index + 1}`}
                        </div>
                        <div class="leaderboard-avatar">
                            ${initials}
                        </div>
                        <div class="leaderboard-info">
                            <div class="leaderboard-name">
                                ${student.name} ${isCurrentUser ? '(You)' : ''}
                            </div>
                            <div class="leaderboard-subtitle">
                                Last active: ${lastActiveText}
                            </div>
                            <div class="leaderboard-stats-row">
                                <span class="stats-badge fire">üî• ${student.streak || 0}</span>
                                <span class="stats-badge time">‚è∞ ${student.totalStudyHours.toFixed(1)}h</span>
                                <span class="stats-badge points">‚≠ê ${student.points || 0}</span>
                            </div>
                        </div>
                        <div class="leaderboard-score">
                            ${student.totalStudyHours.toFixed(1)}h
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

function showLeaderboardEmpty() {
    const leaderboardDiv = document.getElementById('classLeaderboard');
    if (leaderboardDiv) {
        leaderboardDiv.innerHTML = `
            <div class="leaderboard-empty">
                <div style="font-size: 4rem; margin-bottom: var(--spacing-md);">üèÜ</div>
                <h3>No Students Yet</h3>
                <p>Be the first to join and start studying!</p>
            </div>
        `;
    }
}

function showLeaderboardError(message) {
    const leaderboardDiv = document.getElementById('classLeaderboard');
    if (leaderboardDiv) {
        leaderboardDiv.innerHTML = `
            <div class="leaderboard-empty">
                <div style="font-size: 4rem; margin-bottom: var(--spacing-md);">‚ùå</div>
                <h3>Error Loading Leaderboard</h3>
                <p>${message}</p>
                <button class="btn btn-primary" onclick="loadClassLeaderboard()" style="margin-top: var(--spacing-md);">
                    üîÑ Retry
                </button>
            </div>
        `;
    }
}

function refreshLeaderboard() {
    updateSyncStatus("Refreshing leaderboard...", "syncing");
    loadClassLeaderboard();
    setTimeout(() => {
        updateSyncStatus("Leaderboard refreshed", "success");
    }, 500);
}

function copyClassCode() {
    if (!currentClassCode) return;
    
    navigator.clipboard.writeText(currentClassCode).then(() => {
        showNotification("Class code copied to clipboard!", "success");
    });
}

async function refreshClassroom() {
    updateSyncStatus("Refreshing...", "syncing");
    await loadTeacherContent();
    await loadClassLeaderboard();
    setTimeout(() => {
        showNotification("Classroom data refreshed", "success");
        updateSyncStatus("Refreshed", "success");
    }, 500);
}

// ========== STATISTICS & UI UPDATES ==========
function updateAllStatistics() {
    updateUI();
    updateTaskStats();
    updateSidebarStats();
    
    if (currentSection === 'statistics') {
        updateStatisticsSummary();
        updateCharts();
    }
    
    persistData();
}

function updateUI() {
    const streakDisplay = document.getElementById('streakDisplay');
    const streakNumber = document.getElementById('streakNumber');
    if (streakDisplay) streakDisplay.textContent = studyData.streak;
    if (streakNumber) streakNumber.textContent = studyData.streak;
    
    const totalHoursDisplay = document.getElementById('totalHoursDisplay');
    const hours = studyData.totalStudyHours || (studyData.totalMinutes / 60).toFixed(1);
    if (totalHoursDisplay) totalHoursDisplay.textContent = parseFloat(hours).toFixed(1);
    
    const tasksCompleted = tasks.filter(t => t.completed).length;
    const tasksCompletedDisplay = document.getElementById('tasksCompletedDisplay');
    if (tasksCompletedDisplay) tasksCompletedDisplay.textContent = tasksCompleted;
    
    const focusScore = calculateFocusScore();
    const focusScoreDisplay = document.getElementById('focusScoreDisplay');
    if (focusScoreDisplay) focusScoreDisplay.textContent = `${focusScore}%`;
    
    updateSidebarStats();
    updateStreakUI();
}

function updateSidebarStats() {
    const sidebarStreak = document.getElementById('sidebarStreak');
    const sidebarHours = document.getElementById('sidebarHours');
    const sidebarTasks = document.getElementById('sidebarTasks');
    const sidebarFocus = document.getElementById('sidebarFocus');
    
    if (sidebarStreak) sidebarStreak.textContent = studyData.streak || 0;
    if (sidebarHours) {
        const hours = studyData.totalStudyHours || (studyData.totalMinutes / 60).toFixed(1);
        sidebarHours.textContent = parseFloat(hours).toFixed(1);
    }
    if (sidebarTasks) {
        const completedTasks = tasks.filter(t => t.completed).length;
        sidebarTasks.textContent = completedTasks;
    }
    if (sidebarFocus) {
        const focusScore = calculateFocusScore();
        sidebarFocus.textContent = `${focusScore}%`;
    }
}

function calculateFocusScore() {
    let score = 50;
    
    const streakBonus = Math.min(studyData.streak * 5, 30);
    score += streakBonus;
    
    if (studyData.totalStudyDays > 7) score += 10;
    if (studyData.totalStudyDays > 30) score += 10;
    
    const completionRate = tasks.length > 0 ? 
        (tasks.filter(t => t.completed).length / tasks.length) * 100 : 0;
    score += Math.min(completionRate * 0.2, 10);
    
    return Math.min(Math.max(Math.round(score), 0), 100);
}

// ========== PROFILE MANAGEMENT ==========
async function saveProfile() {
    const name = document.getElementById('studentName').value.trim();
    const email = document.getElementById('studentEmail').value.trim();
    const bio = document.getElementById('studentBio').value.trim();
    
    if (!name) {
        showNotification("Please enter your name", "error");
        return;
    }
    
    currentUserName = name;
    saveUserData();
    
    if (currentUserId) {
        try {
            await firebaseUpdate(`users/${currentUserId}`, {
                name: currentUserName,
                email: email,
                bio: bio,
                updatedAt: new Date().toISOString()
            });
            
            await saveStudyDataToFirebase();
            
        } catch (error) {
            console.error("‚ùå Error saving profile to Firebase:", error);
        }
    }
    
    showNotification("Profile saved successfully!", "success");
}

async function saveProfileSettings() {
    const name = document.getElementById('profileName').value.trim();
    const email = document.getElementById('profileEmail').value.trim();
    const bio = document.getElementById('profileBio').value.trim();
    
    if (!name) {
        showNotification("Please enter your name", "error");
        return;
    }
    
    currentUserName = name;
    saveUserData();
    
    document.getElementById('studentName').value = name;
    document.getElementById('studentEmail').value = email;
    document.getElementById('studentBio').value = bio;
    
    if (currentUserId) {
        try {
            await firebaseUpdate(`users/${currentUserId}`, {
                name: currentUserName,
                email: email,
                bio: bio,
                updatedAt: new Date().toISOString()
            });
            
            await saveStudyDataToFirebase();
            
        } catch (error) {
            console.error("‚ùå Error saving profile to Firebase:", error);
        }
    }
    
    showNotification("Profile settings saved successfully!", "success");
}

// ========== NAVIGATION ==========
function showSection(sectionId) {
    currentSection = sectionId;
    persistData();
    
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });
    
    const navItems = document.querySelectorAll('.nav-item');
    for (let item of navItems) {
        if (item.textContent.includes(getNavItemText(sectionId))) {
            item.classList.add('active');
            break;
        }
    }
    
    document.querySelectorAll('.dashboard-content').forEach(section => {
        section.style.display = 'none';
    });
    
    const sectionElement = document.getElementById(sectionId);
    if (sectionElement) {
        sectionElement.style.display = 'block';
    }
    
    updateDashboardHeader(sectionId);
    
    if (sectionId === 'statistics') {
        updateCharts();
    }
}

function getNavItemText(sectionId) {
    const navTexts = {
        'dashboard': 'üìä',
        'tasks': 'üìù',
        'assignments': 'üìö',
        'classroom': 'üè´',
        'myclasses': 'üéì',
        'statistics': 'üìà',
        'tools': 'üõ†Ô∏è',
        'ai': 'ü§ñ',
        'profile': 'üë§'
    };
    return navTexts[sectionId] || '';
}

function updateDashboardHeader(sectionId) {
    const header = document.getElementById('dashboardHeader');
    const subtitle = document.getElementById('dashboardSubtitle');
    
    if (!header || !subtitle) return;
    
    switch(sectionId) {
        case 'dashboard':
            header.querySelector('h1').textContent = 'Welcome to Your Learning Dashboard';
            subtitle.textContent = 'Track your progress, manage tasks, and achieve your study goals';
            break;
        case 'tasks':
            header.querySelector('h1').textContent = 'Task Manager';
            subtitle.textContent = 'Organize and track your daily tasks';
            // FIX: Use renderTasks() instead of loadTasks()
            renderTasks();
            break;
        case 'assignments':
            header.querySelector('h1').textContent = 'Assignment Tracker';
            subtitle.textContent = 'Manage your school assignments and deadlines';
            renderAssignments();
            break;
        case 'classroom':
            header.querySelector('h1').textContent = 'Classroom';
            subtitle.textContent = 'Connect with your teacher and classmates';
            loadClassroomData();
            break;
        case 'myclasses':
            header.querySelector('h1').textContent = 'My Classes';
            subtitle.textContent = 'Manage your classrooms and join new ones';
            renderClassesList();
            break;
        case 'statistics':
            header.querySelector('h1').textContent = 'Learning Statistics';
            subtitle.textContent = 'Visualize your progress with charts and insights';
            updateCharts();
            break;
        case 'tools':
            header.querySelector('h1').textContent = 'Study Tools';
            subtitle.textContent = 'Tools and resources to enhance your learning';
            break;
        case 'ai':
            header.querySelector('h1').textContent = 'AI Learning Resources';
            subtitle.textContent = 'AI-powered tools and educational resources';
            break;
        case 'profile':
            header.querySelector('h1').textContent = 'Profile Settings';
            subtitle.textContent = 'Manage your profile and preferences';
            break;
    }
}

// ========== UTILITY FUNCTIONS ==========
function initUI() {
    // Load theme
    const savedTheme = localStorage.getItem('studentTheme') || 'light';
    document.body.className = savedTheme;
    const themeSelector = document.querySelector('.theme-selector');
    if (themeSelector) themeSelector.value = savedTheme;
    
    // Load motivational content
    loadMotivationalQuote();
    loadInspiringStories();
    
    // Set name in form fields
    const nameField = document.getElementById('studentName');
    if (nameField && currentUserName) nameField.value = currentUserName;
    
    const profileNameField = document.getElementById('profileName');
    if (profileNameField && currentUserName) profileNameField.value = currentUserName;
    
    // Show current section
    showSection(currentSection);
    
    console.log("üé® UI initialized with theme:", savedTheme);
}

function setupEventListeners() {
    const taskInput = document.getElementById('taskInput');
    if (taskInput) {
        taskInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addTask();
        });
    }
    
    const taskInputFull = document.getElementById('taskInputFull');
    if (taskInputFull) {
        taskInputFull.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addTask();
        });
    }
    
    const hoursInput = document.getElementById('hoursInput');
    if (hoursInput) {
        hoursInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addStudyHours();
        });
    }
    
    document.getElementById('storyModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeStoryModal();
        }
    });
    
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeStoryModal();
        }
    });
}

function loadAllData() {
    // FIXED: Use renderTasks() and renderDashboardTasks()
    renderTasks();
    renderDashboardTasks();
    renderAssignments();
    renderDashboardAssignments();
    loadClassroomData();
    loadMotivationalQuote();
    loadInspiringStories();
    updateClassSelector();
    renderClassesList();
    
    const savedProfile = localStorage.getItem('studentProfile');
    if (savedProfile) {
        const profile = JSON.parse(savedProfile);
        document.getElementById('studentName').value = profile.name || '';
        document.getElementById('studentEmail').value = profile.email || '';
        document.getElementById('studentBio').value = profile.bio || '';
        document.getElementById('profileName').value = profile.name || '';
        document.getElementById('profileEmail').value = profile.email || '';
        document.getElementById('profileBio').value = profile.bio || '';
        currentUserName = profile.name || 'Student';
    }
}

// ========== MOTIVATIONAL QUOTES ==========
function loadMotivationalQuote() {
    const randomQuote = inspiringQuotes[Math.floor(Math.random() * inspiringQuotes.length)];
    document.getElementById('dailyQuote').textContent = `"${randomQuote.text}"`;
    document.getElementById('quoteAuthor').textContent = `‚Äî ${randomQuote.author}`;
}

function newQuote() {
    loadMotivationalQuote();
    showNotification("New inspiration loaded! üí´", "info");
}

// ========== NOTIFICATION SYSTEM ==========
function showNotification(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    let icon = 'üí°';
    if (type === 'success') icon = '‚úÖ';
    if (type === 'error') icon = '‚ùå';
    if (type === 'warning') icon = '‚ö†Ô∏è';
    
    toast.innerHTML = `
        <span style="font-size: 1.5rem;">${icon}</span>
        <div style="flex: 1;">
            <div style="font-weight: 700;">${message}</div>
            <div style="font-size: 0.875rem; opacity: 0.8;">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
        </div>
    `;
    
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
    }, 4000);
}

function updateSyncStatus(text, type = "info") {
    const syncStatus = document.getElementById('syncStatus');
    const syncIcon = syncStatus.querySelector('.sync-icon');
    const syncText = syncStatus.querySelector('.sync-text');
    
    if (!syncStatus) return;
    
    syncStatus.style.display = 'flex';
    syncStatus.className = `sync-status ${type}`;
    syncText.textContent = text;
    
    let icon = '‚è≥';
    if (type === 'success') icon = '‚úÖ';
    if (type === 'error') icon = '‚ùå';
    if (type === 'warning') icon = '‚ö†Ô∏è';
    if (type === 'info') icon = '‚ÑπÔ∏è';
    
    syncIcon.textContent = icon;
    
    if (type === 'success') {
        setTimeout(() => {
            syncStatus.style.opacity = '0';
            setTimeout(() => {
                syncStatus.style.display = 'none';
                syncStatus.style.opacity = '1';
            }, 300);
        }, 2000);
    }
}

// ========== THEME MANAGEMENT ==========
function changeTheme(theme) {
    document.body.className = theme;
    localStorage.setItem('studentTheme', theme);
    showNotification(`Switched to ${theme} theme`, "success");
}

// ========== DATA IMPORT/EXPORT ==========
function exportData() {
    const allData = {
        exportDate: new Date().toISOString(),
        version: "2.2",
        user: {
            id: currentUserId,
            name: currentUserName,
            classes: userClasses
        },
        studyData: studyData,
        tasks: tasks,
        assignments: assignments,
        profile: JSON.parse(localStorage.getItem('studentProfile') || '{}')
    };
    
    const dataStr = JSON.stringify(allData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    const exportFileDefaultName = `student-data-${new Date().toISOString().split('T')[0]}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    showNotification("All data exported successfully", "success");
}

function clearAllData() {
    if (confirm("‚ö†Ô∏è This will delete ALL your data including tasks, assignments, study history, and profile. This cannot be undone! Continue?")) {
        localStorage.removeItem('studentPersistentData');
        localStorage.removeItem('studentTasks');
        localStorage.removeItem('studentAssignments');
        localStorage.removeItem('studentStudyData');
        localStorage.removeItem('studentProfile');
        localStorage.removeItem('studentUserClasses');
        localStorage.removeItem('studentUserId');
        localStorage.removeItem('studentName');
        localStorage.removeItem('studentTheme');
        
        tasks = [];
        assignments = [];
        studyData = {
            streak: 0,
            lastStudyDate: "",
            totalMinutes: 0,
            totalStudyDays: 0,
            totalStudyHours: 0,
            studySessions: [],
            weeklyPattern: [0, 0, 0, 0, 0, 0, 0],
            streakHistory: [],
            streakMilestones: [3, 7, 14, 30, 60, 90],
            currentMilestone: 0,
            dailyStats: [],
            focusScores: [],
            consistencyScores: []
        };
        userClasses = [];
        currentClassCode = null;
        selectedClassIndex = -1;
        currentUserId = `student_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        currentUserName = 'Student';
        
        document.getElementById('studentName').value = '';
        document.getElementById('studentEmail').value = '';
        document.getElementById('studentBio').value = '';
        document.getElementById('profileName').value = '';
        document.getElementById('profileEmail').value = '';
        document.getElementById('profileBio').value = '';
        document.getElementById('hoursInput').value = '';
        
        localStorage.setItem('studentUserId', currentUserId);
        
        loadAllData();
        updateAllStatistics();
        
        showNotification("All data cleared", "info");
    }
}

// ========== AUTOSAVE AND REFRESH ==========
function refreshData() {
    const refreshBtn = event.target;
    const originalText = refreshBtn.innerHTML;
    
    refreshBtn.innerHTML = 'üîÑ Refreshing...';
    refreshBtn.disabled = true;
    
    loadAllData();
    updateAllStatistics();
    
    setTimeout(() => {
        refreshBtn.innerHTML = originalText;
        refreshBtn.disabled = false;
        showNotification("All data refreshed", "success");
    }, 1000);
}

// ========== INITIALIZATION COMPLETE ==========
console.log("‚úÖ Student Mode initialized successfully!");
</script>

</body>
</html>